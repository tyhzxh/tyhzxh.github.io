<!DOCTYPE html>
<html lang="en" dir="auto">

<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="noindex, nofollow">
<title>TCP协议深度解析：可靠传输的核心机制 | tyhzxh的个人博客</title>
<meta name="keywords" content="TCP, 网络协议, 传输层, 计算机网络, 可靠传输">
<meta name="description" content="深入解析TCP协议的工作原理、三次握手、四次挥手、流量控制、拥塞控制等核心机制，以及TCP在现代网络中的应用和优化">
<meta name="author" content="tyhzxh">
<link rel="canonical" href="http://localhost:1313/posts/tcp-protocol-guide/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.8ee78296343cf29844826f6d943ca1b6638fc5059dcdf673ace996a7617f1b69.css" integrity="sha256-jueCljQ88phEgm9tlDyhtmOPxQWdzfZzrOmWp2F/G2k=" rel="preload stylesheet" as="style">
<link rel="icon" href="http://localhost:1313/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="http://localhost:1313/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="http://localhost:1313/favicon-32x32.png">
<link rel="apple-touch-icon" href="http://localhost:1313/apple-touch-icon.png">
<link rel="mask-icon" href="http://localhost:1313/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="http://localhost:1313/posts/tcp-protocol-guide/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>
<style>
/* 归档页面摘要样式 */
.archive-summary {
  margin-bottom: 2rem;
  padding: 1rem;
  background: var(--theme);
  border-radius: 8px;
  border: 1px solid var(--border);
  text-align: center;
  color: var(--secondary);
  font-size: 0.9rem;
}

/* 分页导航样式 */
.pagination {
  display: flex !important;
  justify-content: center;
  align-items: center;
  gap: 1rem;
  margin: 3rem 0;
  padding: 2rem 0;
  border-top: 1px solid var(--border);
}

/* 覆盖主题默认样式 */
.pagination a.pagination-prev,
.pagination a.pagination-next {
  padding: 0.75rem 1.5rem !important;
  background: var(--entry) !important;
  border: 1px solid var(--border) !important;
  border-radius: 6px !important;
  text-decoration: none !important;
  color: var(--primary) !important;
  font-weight: 500 !important;
  transition: all 0.3s ease !important;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05) !important;
  font-size: 14px !important;
  line-height: normal !important;
}

.pagination a.pagination-prev:hover,
.pagination a.pagination-next:hover {
  background: var(--hljs-bg) !important;
  color: var(--primary) !important;
  transform: translateY(-2px) !important;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1) !important;
  border-color: var(--tertiary) !important;
}

.pagination-numbers {
  display: flex;
  gap: 0.5rem;
  align-items: center;
}

.pagination a.pagination-number,
.pagination-current {
  display: inline-flex !important;
  align-items: center !important;
  justify-content: center !important;
  width: 2.5rem !important;
  height: 2.5rem !important;
  border-radius: 50% !important;
  text-decoration: none !important;
  font-weight: 500 !important;
  transition: all 0.3s ease !important;
  font-size: 14px !important;
  line-height: normal !important;
  padding: 0 !important;
}

.pagination a.pagination-number {
  background: var(--entry) !important;
  border: 1px solid var(--border) !important;
  color: var(--primary) !important;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05) !important;
}

.pagination a.pagination-number:hover {
  background: var(--hljs-bg) !important;
  color: var(--primary) !important;
  transform: scale(1.1) !important;
  border-color: var(--tertiary) !important;
}

.pagination-current {
  background: var(--tertiary) !important;
  color: var(--primary) !important;
  border: 1px solid var(--tertiary) !important;
  font-weight: 600 !important;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1) !important;
}

/* 响应式设计 */
@media (max-width: 768px) {
  .pagination {
    flex-direction: column;
    gap: 1rem;
  }
  
  .pagination-prev,
  .pagination-next {
    width: 100%;
    text-align: center;
  }
  
  .pagination-numbers {
    order: -1;
  }
  
  .archive-summary {
    font-size: 0.8rem;
    padding: 0.75rem;
  }
}

/* 暗色主题适配 */
[data-theme="dark"] .archive-summary {
  background: var(--entry);
}

[data-theme="dark"] .pagination-prev,
[data-theme="dark"] .pagination-next,
[data-theme="dark"] .pagination-number {
  background: var(--entry);
  border-color: var(--border);
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
}

[data-theme="dark"] .pagination-prev:hover,
[data-theme="dark"] .pagination-next:hover,
[data-theme="dark"] .pagination-number:hover {
  background: var(--hljs-bg);
  border-color: var(--tertiary);
}

[data-theme="dark"] .pagination-current {
  background: var(--tertiary);
  border-color: var(--tertiary);
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
}
</style>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="http://localhost:1313/" accesskey="h" title="tyhzxh的个人博客 (Alt + H)">tyhzxh的个人博客</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)" aria-label="Toggle theme">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="http://localhost:1313/" title="首页">
                    <span>首页</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/posts/" title="文章">
                    <span>文章</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/archives/" title="归档">
                    <span>归档</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/tags/" title="标签">
                    <span>标签</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/search/" title="搜索 (Alt &#43; /)" accesskey=/>
                    <span>搜索</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/about/" title="关于">
                    <span>关于</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="http://localhost:1313/">Home</a>&nbsp;»&nbsp;<a href="http://localhost:1313/posts/">Posts</a></div>
    <h1 class="post-title entry-hint-parent">
      TCP协议深度解析：可靠传输的核心机制
    </h1>
    <div class="post-description">
      深入解析TCP协议的工作原理、三次握手、四次挥手、流量控制、拥塞控制等核心机制，以及TCP在现代网络中的应用和优化
    </div>
    <div class="post-meta"><span title='2024-02-28 14:30:00 +0800 CST'>February 28, 2024</span>&nbsp;·&nbsp;14 min&nbsp;·&nbsp;tyhzxh

</div>
  </header> 
<figure class="entry-cover">
        <img loading="eager" src="https://images.unsplash.com/photo-1544197150-b99a580bb7a8?w=800&amp;h=400&amp;fit=crop" alt="TCP协议与网络通信">
        
</figure><div class="toc">
    <details >
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#tcp%e5%8d%8f%e8%ae%ae%e6%a6%82%e8%bf%b0" aria-label="TCP协议概述">TCP协议概述</a><ul>
                        
                <li>
                    <a href="#tcp%e7%9a%84%e6%a0%b8%e5%bf%83%e7%89%b9%e6%80%a7" aria-label="TCP的核心特性">TCP的核心特性</a></li></ul>
                </li>
                <li>
                    <a href="#tcp%e6%8a%a5%e6%96%87%e6%ae%b5%e7%bb%93%e6%9e%84" aria-label="TCP报文段结构">TCP报文段结构</a><ul>
                        
                <li>
                    <a href="#tcp%e5%a4%b4%e9%83%a8%e6%a0%bc%e5%bc%8f" aria-label="TCP头部格式">TCP头部格式</a></li></ul>
                </li>
                <li>
                    <a href="#tcp%e8%bf%9e%e6%8e%a5%e7%ae%a1%e7%90%86" aria-label="TCP连接管理">TCP连接管理</a><ul>
                        
                <li>
                    <a href="#%e4%b8%89%e6%ac%a1%e6%8f%a1%e6%89%8b%e8%bf%9e%e6%8e%a5%e5%bb%ba%e7%ab%8b" aria-label="三次握手（连接建立）">三次握手（连接建立）</a></li>
                <li>
                    <a href="#tcp%e7%8a%b6%e6%80%81%e8%bd%ac%e6%8d%a2%e5%9b%be" aria-label="TCP状态转换图">TCP状态转换图</a></li></ul>
                </li>
                <li>
                    <a href="#tcp%e5%8f%af%e9%9d%a0%e4%bc%a0%e8%be%93%e6%9c%ba%e5%88%b6" aria-label="TCP可靠传输机制">TCP可靠传输机制</a><ul>
                        
                <li>
                    <a href="#%e5%ba%8f%e5%88%97%e5%8f%b7%e5%92%8c%e7%a1%ae%e8%ae%a4%e6%9c%ba%e5%88%b6" aria-label="序列号和确认机制">序列号和确认机制</a></li></ul>
                </li>
                <li>
                    <a href="#tcp%e6%b5%81%e9%87%8f%e6%8e%a7%e5%88%b6" aria-label="TCP流量控制">TCP流量控制</a><ul>
                        
                <li>
                    <a href="#%e6%bb%91%e5%8a%a8%e7%aa%97%e5%8f%a3%e6%9c%ba%e5%88%b6" aria-label="滑动窗口机制">滑动窗口机制</a></li></ul>
                </li>
                <li>
                    <a href="#tcp%e6%8b%a5%e5%a1%9e%e6%8e%a7%e5%88%b6" aria-label="TCP拥塞控制">TCP拥塞控制</a><ul>
                        
                <li>
                    <a href="#%e6%8b%a5%e5%a1%9e%e6%8e%a7%e5%88%b6%e7%ae%97%e6%b3%95" aria-label="拥塞控制算法">拥塞控制算法</a></li></ul>
                </li>
                <li>
                    <a href="#tcp%e6%80%a7%e8%83%bd%e4%bc%98%e5%8c%96" aria-label="TCP性能优化">TCP性能优化</a><ul>
                        
                <li>
                    <a href="#%e6%80%a7%e8%83%bd%e8%b0%83%e4%bc%98%e6%8a%80%e6%9c%af" aria-label="性能调优技术">性能调优技术</a></li></ul>
                </li>
                <li>
                    <a href="#tcp%e5%9c%a8%e7%8e%b0%e4%bb%a3%e7%bd%91%e7%bb%9c%e4%b8%ad%e7%9a%84%e5%ba%94%e7%94%a8" aria-label="TCP在现代网络中的应用">TCP在现代网络中的应用</a><ul>
                        
                <li>
                    <a href="#tcp%e5%8f%98%e7%a7%8d%e5%92%8c%e6%89%a9%e5%b1%95" aria-label="TCP变种和扩展">TCP变种和扩展</a></li></ul>
                </li>
                <li>
                    <a href="#%e5%ad%a6%e4%b9%a0%e5%bb%ba%e8%ae%ae%e5%92%8c%e6%80%bb%e7%bb%93" aria-label="学习建议和总结">学习建议和总结</a><ul>
                        
                <li>
                    <a href="#tcp%e5%ad%a6%e4%b9%a0%e8%b7%af%e5%be%84" aria-label="TCP学习路径">TCP学习路径</a></li>
                <li>
                    <a href="#%e5%85%b3%e9%94%ae%e8%a6%81%e7%82%b9%e6%80%bb%e7%bb%93" aria-label="关键要点总结">关键要点总结</a></li>
                <li>
                    <a href="#%e5%ae%9e%e9%99%85%e5%ba%94%e7%94%a8%e5%bb%ba%e8%ae%ae" aria-label="实际应用建议">实际应用建议</a></li>
                <li>
                    <a href="#%e6%9c%aa%e6%9d%a5%e5%8f%91%e5%b1%95%e8%b6%8b%e5%8a%bf" aria-label="未来发展趋势">未来发展趋势</a>
                </li>
            </ul>
            </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><h2 id="tcp协议概述">TCP协议概述<a hidden class="anchor" aria-hidden="true" href="#tcp协议概述">#</a></h2>
<p>**TCP（Transmission Control Protocol）**是互联网协议套件中的核心协议之一，位于传输层，为应用层提供可靠的、面向连接的字节流服务。TCP确保数据的完整性、顺序性和可靠性，是现代互联网通信的基石。</p>
<h3 id="tcp的核心特性">TCP的核心特性<a hidden class="anchor" aria-hidden="true" href="#tcp的核心特性">#</a></h3>
<table>
  <thead>
      <tr>
          <th>特性</th>
          <th>描述</th>
          <th>优势</th>
          <th>应用场景</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td><strong>面向连接</strong></td>
          <td>通信前需建立连接</td>
          <td>确保通信双方准备就绪</td>
          <td>需要可靠传输的应用</td>
      </tr>
      <tr>
          <td><strong>可靠传输</strong></td>
          <td>保证数据完整到达</td>
          <td>数据不丢失、不重复</td>
          <td>文件传输、网页浏览</td>
      </tr>
      <tr>
          <td><strong>流量控制</strong></td>
          <td>控制发送速率</td>
          <td>防止接收方缓冲区溢出</td>
          <td>处理能力不同的设备</td>
      </tr>
      <tr>
          <td><strong>拥塞控制</strong></td>
          <td>避免网络拥塞</td>
          <td>提高网络整体性能</td>
          <td>高负载网络环境</td>
      </tr>
      <tr>
          <td><strong>全双工通信</strong></td>
          <td>双向同时传输</td>
          <td>提高通信效率</td>
          <td>实时交互应用</td>
      </tr>
  </tbody>
</table>
<h2 id="tcp报文段结构">TCP报文段结构<a hidden class="anchor" aria-hidden="true" href="#tcp报文段结构">#</a></h2>
<h3 id="tcp头部格式">TCP头部格式<a hidden class="anchor" aria-hidden="true" href="#tcp头部格式">#</a></h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">TCPHeader</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;TCP头部结构解析&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">header_fields</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;源端口&#34;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&#34;位置&#34;</span><span class="p">:</span> <span class="s2">&#34;0-15&#34;</span><span class="p">,</span> <span class="s2">&#34;长度&#34;</span><span class="p">:</span> <span class="s2">&#34;16位&#34;</span><span class="p">,</span> <span class="s2">&#34;描述&#34;</span><span class="p">:</span> <span class="s2">&#34;发送方端口号&#34;</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;目标端口&#34;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&#34;位置&#34;</span><span class="p">:</span> <span class="s2">&#34;16-31&#34;</span><span class="p">,</span> <span class="s2">&#34;长度&#34;</span><span class="p">:</span> <span class="s2">&#34;16位&#34;</span><span class="p">,</span> <span class="s2">&#34;描述&#34;</span><span class="p">:</span> <span class="s2">&#34;接收方端口号&#34;</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;序列号&#34;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&#34;位置&#34;</span><span class="p">:</span> <span class="s2">&#34;32-63&#34;</span><span class="p">,</span> <span class="s2">&#34;长度&#34;</span><span class="p">:</span> <span class="s2">&#34;32位&#34;</span><span class="p">,</span> <span class="s2">&#34;描述&#34;</span><span class="p">:</span> <span class="s2">&#34;数据字节的序列号&#34;</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;确认号&#34;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&#34;位置&#34;</span><span class="p">:</span> <span class="s2">&#34;64-95&#34;</span><span class="p">,</span> <span class="s2">&#34;长度&#34;</span><span class="p">:</span> <span class="s2">&#34;32位&#34;</span><span class="p">,</span> <span class="s2">&#34;描述&#34;</span><span class="p">:</span> <span class="s2">&#34;期望接收的下一个序列号&#34;</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;头部长度&#34;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&#34;位置&#34;</span><span class="p">:</span> <span class="s2">&#34;96-99&#34;</span><span class="p">,</span> <span class="s2">&#34;长度&#34;</span><span class="p">:</span> <span class="s2">&#34;4位&#34;</span><span class="p">,</span> <span class="s2">&#34;描述&#34;</span><span class="p">:</span> <span class="s2">&#34;TCP头部长度&#34;</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;保留位&#34;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&#34;位置&#34;</span><span class="p">:</span> <span class="s2">&#34;100-105&#34;</span><span class="p">,</span> <span class="s2">&#34;长度&#34;</span><span class="p">:</span> <span class="s2">&#34;6位&#34;</span><span class="p">,</span> <span class="s2">&#34;描述&#34;</span><span class="p">:</span> <span class="s2">&#34;保留字段&#34;</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;控制位&#34;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&#34;位置&#34;</span><span class="p">:</span> <span class="s2">&#34;106-111&#34;</span><span class="p">,</span> <span class="s2">&#34;长度&#34;</span><span class="p">:</span> <span class="s2">&#34;6位&#34;</span><span class="p">,</span> <span class="s2">&#34;描述&#34;</span><span class="p">:</span> <span class="s2">&#34;URG、ACK、PSH、RST、SYN、FIN&#34;</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;窗口大小&#34;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&#34;位置&#34;</span><span class="p">:</span> <span class="s2">&#34;112-127&#34;</span><span class="p">,</span> <span class="s2">&#34;长度&#34;</span><span class="p">:</span> <span class="s2">&#34;16位&#34;</span><span class="p">,</span> <span class="s2">&#34;描述&#34;</span><span class="p">:</span> <span class="s2">&#34;接收窗口大小&#34;</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;校验和&#34;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&#34;位置&#34;</span><span class="p">:</span> <span class="s2">&#34;128-143&#34;</span><span class="p">,</span> <span class="s2">&#34;长度&#34;</span><span class="p">:</span> <span class="s2">&#34;16位&#34;</span><span class="p">,</span> <span class="s2">&#34;描述&#34;</span><span class="p">:</span> <span class="s2">&#34;错误检测&#34;</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;紧急指针&#34;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&#34;位置&#34;</span><span class="p">:</span> <span class="s2">&#34;144-159&#34;</span><span class="p">,</span> <span class="s2">&#34;长度&#34;</span><span class="p">:</span> <span class="s2">&#34;16位&#34;</span><span class="p">,</span> <span class="s2">&#34;描述&#34;</span><span class="p">:</span> <span class="s2">&#34;紧急数据指针&#34;</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;选项&#34;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&#34;位置&#34;</span><span class="p">:</span> <span class="s2">&#34;160+&#34;</span><span class="p">,</span> <span class="s2">&#34;长度&#34;</span><span class="p">:</span> <span class="s2">&#34;可变&#34;</span><span class="p">,</span> <span class="s2">&#34;描述&#34;</span><span class="p">:</span> <span class="s2">&#34;TCP选项字段&#34;</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">parse_flags</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flags_byte</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;解析TCP标志位&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">flags</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;URG&#34;</span><span class="p">:</span> <span class="nb">bool</span><span class="p">(</span><span class="n">flags_byte</span> <span class="o">&amp;</span> <span class="mh">0x20</span><span class="p">),</span>  <span class="c1"># 紧急</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;ACK&#34;</span><span class="p">:</span> <span class="nb">bool</span><span class="p">(</span><span class="n">flags_byte</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">),</span>  <span class="c1"># 确认</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;PSH&#34;</span><span class="p">:</span> <span class="nb">bool</span><span class="p">(</span><span class="n">flags_byte</span> <span class="o">&amp;</span> <span class="mh">0x08</span><span class="p">),</span>  <span class="c1"># 推送</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;RST&#34;</span><span class="p">:</span> <span class="nb">bool</span><span class="p">(</span><span class="n">flags_byte</span> <span class="o">&amp;</span> <span class="mh">0x04</span><span class="p">),</span>  <span class="c1"># 重置</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;SYN&#34;</span><span class="p">:</span> <span class="nb">bool</span><span class="p">(</span><span class="n">flags_byte</span> <span class="o">&amp;</span> <span class="mh">0x02</span><span class="p">),</span>  <span class="c1"># 同步</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;FIN&#34;</span><span class="p">:</span> <span class="nb">bool</span><span class="p">(</span><span class="n">flags_byte</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span>   <span class="c1"># 结束</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">flags</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">create_segment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">src_port</span><span class="p">,</span> <span class="n">dst_port</span><span class="p">,</span> <span class="n">seq_num</span><span class="p">,</span> <span class="n">ack_num</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">window_size</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="sa">b</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;创建TCP报文段&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">segment</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;源端口&#34;</span><span class="p">:</span> <span class="n">src_port</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;目标端口&#34;</span><span class="p">:</span> <span class="n">dst_port</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;序列号&#34;</span><span class="p">:</span> <span class="n">seq_num</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;确认号&#34;</span><span class="p">:</span> <span class="n">ack_num</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;头部长度&#34;</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span>  <span class="c1"># 基本头部长度</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;标志位&#34;</span><span class="p">:</span> <span class="n">flags</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;窗口大小&#34;</span><span class="p">:</span> <span class="n">window_size</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;校验和&#34;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>  <span class="c1"># 需要计算</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;数据&#34;</span><span class="p">:</span> <span class="n">data</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;数据长度&#34;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># 计算校验和</span>
</span></span><span class="line"><span class="cl">        <span class="n">segment</span><span class="p">[</span><span class="s2">&#34;校验和&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_checksum</span><span class="p">(</span><span class="n">segment</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">segment</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">calculate_checksum</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">segment</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;计算TCP校验和（简化版）&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># 实际实现需要包含伪头部</span>
</span></span><span class="line"><span class="cl">        <span class="n">checksum</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">        <span class="n">checksum</span> <span class="o">+=</span> <span class="n">segment</span><span class="p">[</span><span class="s2">&#34;源端口&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="n">checksum</span> <span class="o">+=</span> <span class="n">segment</span><span class="p">[</span><span class="s2">&#34;目标端口&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="n">checksum</span> <span class="o">+=</span> <span class="p">(</span><span class="n">segment</span><span class="p">[</span><span class="s2">&#34;序列号&#34;</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">segment</span><span class="p">[</span><span class="s2">&#34;序列号&#34;</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xFFFF</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">checksum</span> <span class="o">+=</span> <span class="p">(</span><span class="n">segment</span><span class="p">[</span><span class="s2">&#34;确认号&#34;</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">segment</span><span class="p">[</span><span class="s2">&#34;确认号&#34;</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xFFFF</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># 处理进位</span>
</span></span><span class="line"><span class="cl">        <span class="k">while</span> <span class="n">checksum</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">checksum</span> <span class="o">=</span> <span class="p">(</span><span class="n">checksum</span> <span class="o">&amp;</span> <span class="mh">0xFFFF</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">checksum</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="o">~</span><span class="n">checksum</span> <span class="o">&amp;</span> <span class="mh">0xFFFF</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># TCP报文段示例</span>
</span></span><span class="line"><span class="cl"><span class="n">tcp_header</span> <span class="o">=</span> <span class="n">TCPHeader</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 创建SYN报文段</span>
</span></span><span class="line"><span class="cl"><span class="n">syn_segment</span> <span class="o">=</span> <span class="n">tcp_header</span><span class="o">.</span><span class="n">create_segment</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">src_port</span><span class="o">=</span><span class="mi">12345</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">dst_port</span><span class="o">=</span><span class="mi">80</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">seq_num</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">ack_num</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">flags</span><span class="o">=</span><span class="p">{</span><span class="s2">&#34;SYN&#34;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&#34;ACK&#34;</span><span class="p">:</span> <span class="kc">False</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="n">window_size</span><span class="o">=</span><span class="mi">65535</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="s2">&#34;SYN报文段:&#34;</span><span class="p">,</span> <span class="n">syn_segment</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 解析标志位</span>
</span></span><span class="line"><span class="cl"><span class="n">flags_byte</span> <span class="o">=</span> <span class="mh">0x02</span>  <span class="c1"># SYN标志</span>
</span></span><span class="line"><span class="cl"><span class="n">parsed_flags</span> <span class="o">=</span> <span class="n">tcp_header</span><span class="o">.</span><span class="n">parse_flags</span><span class="p">(</span><span class="n">flags_byte</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="s2">&#34;解析的标志位:&#34;</span><span class="p">,</span> <span class="n">parsed_flags</span><span class="p">)</span>
</span></span></code></pre></div><h2 id="tcp连接管理">TCP连接管理<a hidden class="anchor" aria-hidden="true" href="#tcp连接管理">#</a></h2>
<h3 id="三次握手连接建立">三次握手（连接建立）<a hidden class="anchor" aria-hidden="true" href="#三次握手连接建立">#</a></h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">TCPConnection</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;TCP连接管理&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="s2">&#34;CLOSED&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">seq_num</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">ack_num</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">connections</span> <span class="o">=</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">three_way_handshake</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client_id</span><span class="p">,</span> <span class="n">server_id</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;三次握手过程模拟&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">handshake_steps</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># 第一步：客户端发送SYN</span>
</span></span><span class="line"><span class="cl">        <span class="n">client_seq</span> <span class="o">=</span> <span class="mi">1000</span>
</span></span><span class="line"><span class="cl">        <span class="n">step1</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;步骤&#34;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;发送方&#34;</span><span class="p">:</span> <span class="n">client_id</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;接收方&#34;</span><span class="p">:</span> <span class="n">server_id</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;报文类型&#34;</span><span class="p">:</span> <span class="s2">&#34;SYN&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;序列号&#34;</span><span class="p">:</span> <span class="n">client_seq</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;确认号&#34;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;标志位&#34;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&#34;SYN&#34;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&#34;ACK&#34;</span><span class="p">:</span> <span class="kc">False</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;描述&#34;</span><span class="p">:</span> <span class="s2">&#34;客户端请求建立连接&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;客户端状态&#34;</span><span class="p">:</span> <span class="s2">&#34;SYN_SENT&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;服务器状态&#34;</span><span class="p">:</span> <span class="s2">&#34;LISTEN&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">handshake_steps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">step1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># 第二步：服务器发送SYN+ACK</span>
</span></span><span class="line"><span class="cl">        <span class="n">server_seq</span> <span class="o">=</span> <span class="mi">2000</span>
</span></span><span class="line"><span class="cl">        <span class="n">step2</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;步骤&#34;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;发送方&#34;</span><span class="p">:</span> <span class="n">server_id</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;接收方&#34;</span><span class="p">:</span> <span class="n">client_id</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;报文类型&#34;</span><span class="p">:</span> <span class="s2">&#34;SYN+ACK&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;序列号&#34;</span><span class="p">:</span> <span class="n">server_seq</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;确认号&#34;</span><span class="p">:</span> <span class="n">client_seq</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;标志位&#34;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&#34;SYN&#34;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&#34;ACK&#34;</span><span class="p">:</span> <span class="kc">True</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;描述&#34;</span><span class="p">:</span> <span class="s2">&#34;服务器确认连接请求并发送自己的连接请求&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;客户端状态&#34;</span><span class="p">:</span> <span class="s2">&#34;SYN_SENT&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;服务器状态&#34;</span><span class="p">:</span> <span class="s2">&#34;SYN_RCVD&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">handshake_steps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">step2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># 第三步：客户端发送ACK</span>
</span></span><span class="line"><span class="cl">        <span class="n">step3</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;步骤&#34;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;发送方&#34;</span><span class="p">:</span> <span class="n">client_id</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;接收方&#34;</span><span class="p">:</span> <span class="n">server_id</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;报文类型&#34;</span><span class="p">:</span> <span class="s2">&#34;ACK&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;序列号&#34;</span><span class="p">:</span> <span class="n">client_seq</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;确认号&#34;</span><span class="p">:</span> <span class="n">server_seq</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;标志位&#34;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&#34;SYN&#34;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&#34;ACK&#34;</span><span class="p">:</span> <span class="kc">True</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;描述&#34;</span><span class="p">:</span> <span class="s2">&#34;客户端确认服务器的连接请求&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;客户端状态&#34;</span><span class="p">:</span> <span class="s2">&#34;ESTABLISHED&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;服务器状态&#34;</span><span class="p">:</span> <span class="s2">&#34;ESTABLISHED&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">handshake_steps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">step3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># 建立连接</span>
</span></span><span class="line"><span class="cl">        <span class="n">connection_id</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&#34;</span><span class="si">{</span><span class="n">client_id</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">server_id</span><span class="si">}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">connections</span><span class="p">[</span><span class="n">connection_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;客户端&#34;</span><span class="p">:</span> <span class="n">client_id</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;服务器&#34;</span><span class="p">:</span> <span class="n">server_id</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;状态&#34;</span><span class="p">:</span> <span class="s2">&#34;ESTABLISHED&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;客户端序列号&#34;</span><span class="p">:</span> <span class="n">client_seq</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;服务器序列号&#34;</span><span class="p">:</span> <span class="n">server_seq</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;建立时间&#34;</span><span class="p">:</span> <span class="s2">&#34;2024-02-28T14:30:00Z&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;握手步骤&#34;</span><span class="p">:</span> <span class="n">handshake_steps</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;连接信息&#34;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">connections</span><span class="p">[</span><span class="n">connection_id</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;连接ID&#34;</span><span class="p">:</span> <span class="n">connection_id</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">four_way_handshake</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">connection_id</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;四次挥手过程模拟&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">connection_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">connections</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="p">{</span><span class="s2">&#34;错误&#34;</span><span class="p">:</span> <span class="s2">&#34;连接不存在&#34;</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="n">connection</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">connections</span><span class="p">[</span><span class="n">connection_id</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="n">client_id</span> <span class="o">=</span> <span class="n">connection</span><span class="p">[</span><span class="s2">&#34;客户端&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="n">server_id</span> <span class="o">=</span> <span class="n">connection</span><span class="p">[</span><span class="s2">&#34;服务器&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="n">handshake_steps</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># 第一步：客户端发送FIN</span>
</span></span><span class="line"><span class="cl">        <span class="n">step1</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;步骤&#34;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;发送方&#34;</span><span class="p">:</span> <span class="n">client_id</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;接收方&#34;</span><span class="p">:</span> <span class="n">server_id</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;报文类型&#34;</span><span class="p">:</span> <span class="s2">&#34;FIN&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;标志位&#34;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&#34;FIN&#34;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&#34;ACK&#34;</span><span class="p">:</span> <span class="kc">False</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;描述&#34;</span><span class="p">:</span> <span class="s2">&#34;客户端请求关闭连接&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;客户端状态&#34;</span><span class="p">:</span> <span class="s2">&#34;FIN_WAIT_1&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;服务器状态&#34;</span><span class="p">:</span> <span class="s2">&#34;ESTABLISHED&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">handshake_steps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">step1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># 第二步：服务器发送ACK</span>
</span></span><span class="line"><span class="cl">        <span class="n">step2</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;步骤&#34;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;发送方&#34;</span><span class="p">:</span> <span class="n">server_id</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;接收方&#34;</span><span class="p">:</span> <span class="n">client_id</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;报文类型&#34;</span><span class="p">:</span> <span class="s2">&#34;ACK&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;标志位&#34;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&#34;FIN&#34;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&#34;ACK&#34;</span><span class="p">:</span> <span class="kc">True</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;描述&#34;</span><span class="p">:</span> <span class="s2">&#34;服务器确认客户端的关闭请求&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;客户端状态&#34;</span><span class="p">:</span> <span class="s2">&#34;FIN_WAIT_2&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;服务器状态&#34;</span><span class="p">:</span> <span class="s2">&#34;CLOSE_WAIT&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">handshake_steps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">step2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># 第三步：服务器发送FIN</span>
</span></span><span class="line"><span class="cl">        <span class="n">step3</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;步骤&#34;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;发送方&#34;</span><span class="p">:</span> <span class="n">server_id</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;接收方&#34;</span><span class="p">:</span> <span class="n">client_id</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;报文类型&#34;</span><span class="p">:</span> <span class="s2">&#34;FIN&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;标志位&#34;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&#34;FIN&#34;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&#34;ACK&#34;</span><span class="p">:</span> <span class="kc">False</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;描述&#34;</span><span class="p">:</span> <span class="s2">&#34;服务器请求关闭连接&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;客户端状态&#34;</span><span class="p">:</span> <span class="s2">&#34;FIN_WAIT_2&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;服务器状态&#34;</span><span class="p">:</span> <span class="s2">&#34;LAST_ACK&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">handshake_steps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">step3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># 第四步：客户端发送ACK</span>
</span></span><span class="line"><span class="cl">        <span class="n">step4</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;步骤&#34;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;发送方&#34;</span><span class="p">:</span> <span class="n">client_id</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;接收方&#34;</span><span class="p">:</span> <span class="n">server_id</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;报文类型&#34;</span><span class="p">:</span> <span class="s2">&#34;ACK&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;标志位&#34;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&#34;FIN&#34;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&#34;ACK&#34;</span><span class="p">:</span> <span class="kc">True</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;描述&#34;</span><span class="p">:</span> <span class="s2">&#34;客户端确认服务器的关闭请求&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;客户端状态&#34;</span><span class="p">:</span> <span class="s2">&#34;TIME_WAIT&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;服务器状态&#34;</span><span class="p">:</span> <span class="s2">&#34;CLOSED&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">handshake_steps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">step4</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># 删除连接</span>
</span></span><span class="line"><span class="cl">        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">connections</span><span class="p">[</span><span class="n">connection_id</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;挥手步骤&#34;</span><span class="p">:</span> <span class="n">handshake_steps</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;连接状态&#34;</span><span class="p">:</span> <span class="s2">&#34;已关闭&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 连接管理示例</span>
</span></span><span class="line"><span class="cl"><span class="n">tcp_conn</span> <span class="o">=</span> <span class="n">TCPConnection</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 建立连接</span>
</span></span><span class="line"><span class="cl"><span class="n">connection_result</span> <span class="o">=</span> <span class="n">tcp_conn</span><span class="o">.</span><span class="n">three_way_handshake</span><span class="p">(</span><span class="s2">&#34;Client_A&#34;</span><span class="p">,</span> <span class="s2">&#34;Server_B&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="s2">&#34;三次握手结果:&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="n">connection_result</span><span class="p">[</span><span class="s2">&#34;握手步骤&#34;</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;步骤</span><span class="si">{</span><span class="n">step</span><span class="p">[</span><span class="s1">&#39;步骤&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">step</span><span class="p">[</span><span class="s1">&#39;发送方&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="n">step</span><span class="p">[</span><span class="s1">&#39;接收方&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">step</span><span class="p">[</span><span class="s1">&#39;报文类型&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">) - </span><span class="si">{</span><span class="n">step</span><span class="p">[</span><span class="s1">&#39;描述&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">连接建立成功: </span><span class="si">{</span><span class="n">connection_result</span><span class="p">[</span><span class="s1">&#39;连接ID&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 关闭连接</span>
</span></span><span class="line"><span class="cl"><span class="n">close_result</span> <span class="o">=</span> <span class="n">tcp_conn</span><span class="o">.</span><span class="n">four_way_handshake</span><span class="p">(</span><span class="n">connection_result</span><span class="p">[</span><span class="s1">&#39;连接ID&#39;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">四次挥手结果:&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="n">close_result</span><span class="p">[</span><span class="s2">&#34;挥手步骤&#34;</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;步骤</span><span class="si">{</span><span class="n">step</span><span class="p">[</span><span class="s1">&#39;步骤&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">step</span><span class="p">[</span><span class="s1">&#39;发送方&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="n">step</span><span class="p">[</span><span class="s1">&#39;接收方&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">step</span><span class="p">[</span><span class="s1">&#39;报文类型&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">) - </span><span class="si">{</span><span class="n">step</span><span class="p">[</span><span class="s1">&#39;描述&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span></code></pre></div><h3 id="tcp状态转换图">TCP状态转换图<a hidden class="anchor" aria-hidden="true" href="#tcp状态转换图">#</a></h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">TCPStateMachine</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;TCP状态机&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">states</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;CLOSED&#34;</span><span class="p">:</span> <span class="s2">&#34;关闭状态&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;LISTEN&#34;</span><span class="p">:</span> <span class="s2">&#34;监听状态&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;SYN_SENT&#34;</span><span class="p">:</span> <span class="s2">&#34;已发送SYN&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;SYN_RCVD&#34;</span><span class="p">:</span> <span class="s2">&#34;已接收SYN&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;ESTABLISHED&#34;</span><span class="p">:</span> <span class="s2">&#34;连接已建立&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;FIN_WAIT_1&#34;</span><span class="p">:</span> <span class="s2">&#34;等待FIN确认&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;FIN_WAIT_2&#34;</span><span class="p">:</span> <span class="s2">&#34;等待对方FIN&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;CLOSE_WAIT&#34;</span><span class="p">:</span> <span class="s2">&#34;等待关闭&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;CLOSING&#34;</span><span class="p">:</span> <span class="s2">&#34;正在关闭&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;LAST_ACK&#34;</span><span class="p">:</span> <span class="s2">&#34;最后确认&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;TIME_WAIT&#34;</span><span class="p">:</span> <span class="s2">&#34;时间等待&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">transitions</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="p">(</span><span class="s2">&#34;CLOSED&#34;</span><span class="p">,</span> <span class="s2">&#34;主动打开&#34;</span><span class="p">):</span> <span class="s2">&#34;SYN_SENT&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="p">(</span><span class="s2">&#34;CLOSED&#34;</span><span class="p">,</span> <span class="s2">&#34;被动打开&#34;</span><span class="p">):</span> <span class="s2">&#34;LISTEN&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="p">(</span><span class="s2">&#34;LISTEN&#34;</span><span class="p">,</span> <span class="s2">&#34;收到SYN&#34;</span><span class="p">):</span> <span class="s2">&#34;SYN_RCVD&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="p">(</span><span class="s2">&#34;SYN_SENT&#34;</span><span class="p">,</span> <span class="s2">&#34;收到SYN+ACK&#34;</span><span class="p">):</span> <span class="s2">&#34;ESTABLISHED&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="p">(</span><span class="s2">&#34;SYN_RCVD&#34;</span><span class="p">,</span> <span class="s2">&#34;收到ACK&#34;</span><span class="p">):</span> <span class="s2">&#34;ESTABLISHED&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="p">(</span><span class="s2">&#34;ESTABLISHED&#34;</span><span class="p">,</span> <span class="s2">&#34;主动关闭&#34;</span><span class="p">):</span> <span class="s2">&#34;FIN_WAIT_1&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="p">(</span><span class="s2">&#34;ESTABLISHED&#34;</span><span class="p">,</span> <span class="s2">&#34;收到FIN&#34;</span><span class="p">):</span> <span class="s2">&#34;CLOSE_WAIT&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="p">(</span><span class="s2">&#34;FIN_WAIT_1&#34;</span><span class="p">,</span> <span class="s2">&#34;收到ACK&#34;</span><span class="p">):</span> <span class="s2">&#34;FIN_WAIT_2&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="p">(</span><span class="s2">&#34;FIN_WAIT_1&#34;</span><span class="p">,</span> <span class="s2">&#34;收到FIN&#34;</span><span class="p">):</span> <span class="s2">&#34;CLOSING&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="p">(</span><span class="s2">&#34;FIN_WAIT_2&#34;</span><span class="p">,</span> <span class="s2">&#34;收到FIN&#34;</span><span class="p">):</span> <span class="s2">&#34;TIME_WAIT&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="p">(</span><span class="s2">&#34;CLOSE_WAIT&#34;</span><span class="p">,</span> <span class="s2">&#34;主动关闭&#34;</span><span class="p">):</span> <span class="s2">&#34;LAST_ACK&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="p">(</span><span class="s2">&#34;CLOSING&#34;</span><span class="p">,</span> <span class="s2">&#34;收到ACK&#34;</span><span class="p">):</span> <span class="s2">&#34;TIME_WAIT&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="p">(</span><span class="s2">&#34;LAST_ACK&#34;</span><span class="p">,</span> <span class="s2">&#34;收到ACK&#34;</span><span class="p">):</span> <span class="s2">&#34;CLOSED&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="p">(</span><span class="s2">&#34;TIME_WAIT&#34;</span><span class="p">,</span> <span class="s2">&#34;超时&#34;</span><span class="p">):</span> <span class="s2">&#34;CLOSED&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">get_next_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">current_state</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;获取下一个状态&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">transition</span> <span class="o">=</span> <span class="p">(</span><span class="n">current_state</span><span class="p">,</span> <span class="n">event</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">transitions</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">transition</span><span class="p">,</span> <span class="n">current_state</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">simulate_connection_lifecycle</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;模拟连接生命周期&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">lifecycle</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># 客户端状态变化</span>
</span></span><span class="line"><span class="cl">        <span class="n">client_states</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">            <span class="p">(</span><span class="s2">&#34;CLOSED&#34;</span><span class="p">,</span> <span class="s2">&#34;主动打开&#34;</span><span class="p">,</span> <span class="s2">&#34;SYN_SENT&#34;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">            <span class="p">(</span><span class="s2">&#34;SYN_SENT&#34;</span><span class="p">,</span> <span class="s2">&#34;收到SYN+ACK&#34;</span><span class="p">,</span> <span class="s2">&#34;ESTABLISHED&#34;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">            <span class="p">(</span><span class="s2">&#34;ESTABLISHED&#34;</span><span class="p">,</span> <span class="s2">&#34;主动关闭&#34;</span><span class="p">,</span> <span class="s2">&#34;FIN_WAIT_1&#34;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">            <span class="p">(</span><span class="s2">&#34;FIN_WAIT_1&#34;</span><span class="p">,</span> <span class="s2">&#34;收到ACK&#34;</span><span class="p">,</span> <span class="s2">&#34;FIN_WAIT_2&#34;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">            <span class="p">(</span><span class="s2">&#34;FIN_WAIT_2&#34;</span><span class="p">,</span> <span class="s2">&#34;收到FIN&#34;</span><span class="p">,</span> <span class="s2">&#34;TIME_WAIT&#34;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">            <span class="p">(</span><span class="s2">&#34;TIME_WAIT&#34;</span><span class="p">,</span> <span class="s2">&#34;超时&#34;</span><span class="p">,</span> <span class="s2">&#34;CLOSED&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">]</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># 服务器状态变化</span>
</span></span><span class="line"><span class="cl">        <span class="n">server_states</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">            <span class="p">(</span><span class="s2">&#34;CLOSED&#34;</span><span class="p">,</span> <span class="s2">&#34;被动打开&#34;</span><span class="p">,</span> <span class="s2">&#34;LISTEN&#34;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">            <span class="p">(</span><span class="s2">&#34;LISTEN&#34;</span><span class="p">,</span> <span class="s2">&#34;收到SYN&#34;</span><span class="p">,</span> <span class="s2">&#34;SYN_RCVD&#34;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">            <span class="p">(</span><span class="s2">&#34;SYN_RCVD&#34;</span><span class="p">,</span> <span class="s2">&#34;收到ACK&#34;</span><span class="p">,</span> <span class="s2">&#34;ESTABLISHED&#34;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">            <span class="p">(</span><span class="s2">&#34;ESTABLISHED&#34;</span><span class="p">,</span> <span class="s2">&#34;收到FIN&#34;</span><span class="p">,</span> <span class="s2">&#34;CLOSE_WAIT&#34;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">            <span class="p">(</span><span class="s2">&#34;CLOSE_WAIT&#34;</span><span class="p">,</span> <span class="s2">&#34;主动关闭&#34;</span><span class="p">,</span> <span class="s2">&#34;LAST_ACK&#34;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">            <span class="p">(</span><span class="s2">&#34;LAST_ACK&#34;</span><span class="p">,</span> <span class="s2">&#34;收到ACK&#34;</span><span class="p">,</span> <span class="s2">&#34;CLOSED&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">]</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;客户端状态变化&#34;</span><span class="p">:</span> <span class="n">client_states</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;服务器状态变化&#34;</span><span class="p">:</span> <span class="n">server_states</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 状态机示例</span>
</span></span><span class="line"><span class="cl"><span class="n">state_machine</span> <span class="o">=</span> <span class="n">TCPStateMachine</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">lifecycle</span> <span class="o">=</span> <span class="n">state_machine</span><span class="o">.</span><span class="n">simulate_connection_lifecycle</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="s2">&#34;TCP连接生命周期:&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">客户端状态变化:&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">current</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">next_state</span> <span class="ow">in</span> <span class="n">lifecycle</span><span class="p">[</span><span class="s2">&#34;客户端状态变化&#34;</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;  </span><span class="si">{</span><span class="n">current</span><span class="si">}</span><span class="s2"> --[</span><span class="si">{</span><span class="n">event</span><span class="si">}</span><span class="s2">]--&gt; </span><span class="si">{</span><span class="n">next_state</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">服务器状态变化:&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">current</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">next_state</span> <span class="ow">in</span> <span class="n">lifecycle</span><span class="p">[</span><span class="s2">&#34;服务器状态变化&#34;</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;  </span><span class="si">{</span><span class="n">current</span><span class="si">}</span><span class="s2"> --[</span><span class="si">{</span><span class="n">event</span><span class="si">}</span><span class="s2">]--&gt; </span><span class="si">{</span><span class="n">next_state</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span></code></pre></div><h2 id="tcp可靠传输机制">TCP可靠传输机制<a hidden class="anchor" aria-hidden="true" href="#tcp可靠传输机制">#</a></h2>
<h3 id="序列号和确认机制">序列号和确认机制<a hidden class="anchor" aria-hidden="true" href="#序列号和确认机制">#</a></h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">TCPReliableTransmission</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;TCP可靠传输机制&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">initial_seq</span><span class="o">=</span><span class="mi">1000</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">seq_num</span> <span class="o">=</span> <span class="n">initial_seq</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">ack_num</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">send_buffer</span> <span class="o">=</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">receive_buffer</span> <span class="o">=</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">expected_seq</span> <span class="o">=</span> <span class="n">initial_seq</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">rtt_samples</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">rto</span> <span class="o">=</span> <span class="mf">1.0</span>  <span class="c1"># 重传超时时间</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">send_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">segment_size</span><span class="o">=</span><span class="mi">1024</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;发送数据&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">segments</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">        <span class="n">data_bytes</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="n">data</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># 分段发送</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">data_bytes</span><span class="p">),</span> <span class="n">segment_size</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">segment_data</span> <span class="o">=</span> <span class="n">data_bytes</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span> <span class="o">+</span> <span class="n">segment_size</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">            <span class="n">segment</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;序列号&#34;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">seq_num</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;数据&#34;</span><span class="p">:</span> <span class="n">segment_data</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;长度&#34;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">segment_data</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;发送时间&#34;</span><span class="p">:</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;重传次数&#34;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;已确认&#34;</span><span class="p">:</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="n">segments</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">segment</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">send_buffer</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">seq_num</span><span class="p">]</span> <span class="o">=</span> <span class="n">segment</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">seq_num</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">segment_data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">segments</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">receive_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">segment</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;接收数据&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">seq_num</span> <span class="o">=</span> <span class="n">segment</span><span class="p">[</span><span class="s2">&#34;序列号&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="n">data</span> <span class="o">=</span> <span class="n">segment</span><span class="p">[</span><span class="s2">&#34;数据&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="n">data_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># 检查序列号</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">seq_num</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">expected_seq</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># 按序到达</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">receive_buffer</span><span class="p">[</span><span class="n">seq_num</span><span class="p">]</span> <span class="o">=</span> <span class="n">segment</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">expected_seq</span> <span class="o">+=</span> <span class="n">data_len</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="c1"># 检查缓冲区中是否有连续的数据</span>
</span></span><span class="line"><span class="cl">            <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">expected_seq</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">receive_buffer</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">next_segment</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">receive_buffer</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">expected_seq</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">                <span class="bp">self</span><span class="o">.</span><span class="n">expected_seq</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">next_segment</span><span class="p">[</span><span class="s2">&#34;数据&#34;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;状态&#34;</span><span class="p">:</span> <span class="s2">&#34;按序接收&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;确认号&#34;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">expected_seq</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;接收数据&#34;</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">)</span> <span class="k">else</span> <span class="n">data</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="k">elif</span> <span class="n">seq_num</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">expected_seq</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># 失序到达，缓存数据</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">receive_buffer</span><span class="p">[</span><span class="n">seq_num</span><span class="p">]</span> <span class="o">=</span> <span class="n">segment</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;状态&#34;</span><span class="p">:</span> <span class="s2">&#34;失序接收&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;确认号&#34;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">expected_seq</span><span class="p">,</span>  <span class="c1"># 发送期望的序列号</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;缓存数据&#34;</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">)</span> <span class="k">else</span> <span class="n">data</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># 重复数据</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;状态&#34;</span><span class="p">:</span> <span class="s2">&#34;重复数据&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;确认号&#34;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">expected_seq</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;丢弃数据&#34;</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">)</span> <span class="k">else</span> <span class="n">data</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">process_ack</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ack_num</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;处理确认&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">confirmed_segments</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># 确认所有序列号小于ack_num的段</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">seq_num</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">send_buffer</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">seq_num</span> <span class="o">&lt;</span> <span class="n">ack_num</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">segment</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">send_buffer</span><span class="p">[</span><span class="n">seq_num</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">                <span class="n">segment</span><span class="p">[</span><span class="s2">&#34;已确认&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">                <span class="n">confirmed_segments</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">segment</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                
</span></span><span class="line"><span class="cl">                <span class="c1"># 计算RTT</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="s2">&#34;发送时间&#34;</span> <span class="ow">in</span> <span class="n">segment</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">rtt</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">segment</span><span class="p">[</span><span class="s2">&#34;发送时间&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">                    <span class="bp">self</span><span class="o">.</span><span class="n">rtt_samples</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rtt</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="bp">self</span><span class="o">.</span><span class="n">update_rto</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                
</span></span><span class="line"><span class="cl">                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">send_buffer</span><span class="p">[</span><span class="n">seq_num</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;确认的段数&#34;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">confirmed_segments</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;剩余未确认段数&#34;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">send_buffer</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;当前RTO&#34;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">rto</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">update_rto</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;更新重传超时时间&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">rtt_samples</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># 简化的RTO计算</span>
</span></span><span class="line"><span class="cl">        <span class="n">avg_rtt</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rtt_samples</span><span class="p">[</span><span class="o">-</span><span class="mi">10</span><span class="p">:])</span> <span class="o">/</span> <span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rtt_samples</span><span class="p">),</span> <span class="mi">10</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">rto</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">avg_rtt</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>  <span class="c1"># 简单的RTO算法</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">check_timeout</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;检查超时重传&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">current_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">timeout_segments</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">seq_num</span><span class="p">,</span> <span class="n">segment</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">send_buffer</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="ow">not</span> <span class="n">segment</span><span class="p">[</span><span class="s2">&#34;已确认&#34;</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">                <span class="n">elapsed</span> <span class="o">=</span> <span class="n">current_time</span> <span class="o">-</span> <span class="n">segment</span><span class="p">[</span><span class="s2">&#34;发送时间&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">elapsed</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">rto</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">segment</span><span class="p">[</span><span class="s2">&#34;重传次数&#34;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">                    <span class="n">segment</span><span class="p">[</span><span class="s2">&#34;发送时间&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="n">current_time</span>
</span></span><span class="line"><span class="cl">                    <span class="n">timeout_segments</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">segment</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">timeout_segments</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 可靠传输示例</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">time</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">sender</span> <span class="o">=</span> <span class="n">TCPReliableTransmission</span><span class="p">(</span><span class="n">initial_seq</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">receiver</span> <span class="o">=</span> <span class="n">TCPReliableTransmission</span><span class="p">(</span><span class="n">initial_seq</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 发送数据</span>
</span></span><span class="line"><span class="cl"><span class="n">message</span> <span class="o">=</span> <span class="s2">&#34;Hello, TCP World! This is a test message for reliable transmission.&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">segments</span> <span class="o">=</span> <span class="n">sender</span><span class="o">.</span><span class="n">send_data</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">segment_size</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="s2">&#34;发送的数据段:&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">segment</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">segments</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;段</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">: 序列号=</span><span class="si">{</span><span class="n">segment</span><span class="p">[</span><span class="s1">&#39;序列号&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">, 长度=</span><span class="si">{</span><span class="n">segment</span><span class="p">[</span><span class="s1">&#39;长度&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">, 数据=&#39;</span><span class="si">{</span><span class="n">segment</span><span class="p">[</span><span class="s1">&#39;数据&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span><span class="si">}</span><span class="s2">&#39;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">接收过程:&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 模拟按序接收</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">segment</span> <span class="ow">in</span> <span class="n">segments</span><span class="p">[:</span><span class="mi">3</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">    <span class="n">result</span> <span class="o">=</span> <span class="n">receiver</span><span class="o">.</span><span class="n">receive_data</span><span class="p">(</span><span class="n">segment</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;接收段 </span><span class="si">{</span><span class="n">segment</span><span class="p">[</span><span class="s1">&#39;序列号&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;状态&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">, 确认号=</span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;确认号&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 模拟失序接收（跳过一个段）</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">segments</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">result</span> <span class="o">=</span> <span class="n">receiver</span><span class="o">.</span><span class="n">receive_data</span><span class="p">(</span><span class="n">segments</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;接收段 </span><span class="si">{</span><span class="n">segments</span><span class="p">[</span><span class="mi">4</span><span class="p">][</span><span class="s1">&#39;序列号&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;状态&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">, 确认号=</span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;确认号&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 接收缺失的段</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">segments</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">result</span> <span class="o">=</span> <span class="n">receiver</span><span class="o">.</span><span class="n">receive_data</span><span class="p">(</span><span class="n">segments</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;接收段 </span><span class="si">{</span><span class="n">segments</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="s1">&#39;序列号&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;状态&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">, 确认号=</span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;确认号&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span></code></pre></div><h2 id="tcp流量控制">TCP流量控制<a hidden class="anchor" aria-hidden="true" href="#tcp流量控制">#</a></h2>
<h3 id="滑动窗口机制">滑动窗口机制<a hidden class="anchor" aria-hidden="true" href="#滑动窗口机制">#</a></h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">TCPFlowControl</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;TCP流量控制&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">window_size</span><span class="o">=</span><span class="mi">65535</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">window_size</span> <span class="o">=</span> <span class="n">window_size</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">send_window</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;base&#34;</span><span class="p">:</span> <span class="mi">1000</span><span class="p">,</span>  <span class="c1"># 发送窗口基序号</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;next_seq&#34;</span><span class="p">:</span> <span class="mi">1000</span><span class="p">,</span>  <span class="c1"># 下一个发送序号</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;size&#34;</span><span class="p">:</span> <span class="n">window_size</span><span class="p">,</span>  <span class="c1"># 窗口大小</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;used&#34;</span><span class="p">:</span> <span class="mi">0</span>  <span class="c1"># 已使用窗口大小</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">receive_window</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;base&#34;</span><span class="p">:</span> <span class="mi">1000</span><span class="p">,</span>  <span class="c1"># 接收窗口基序号</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;size&#34;</span><span class="p">:</span> <span class="n">window_size</span><span class="p">,</span>  <span class="c1"># 窗口大小</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;available&#34;</span><span class="p">:</span> <span class="n">window_size</span><span class="p">,</span>  <span class="c1"># 可用窗口大小</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;buffer&#34;</span><span class="p">:</span> <span class="p">{}</span>  <span class="c1"># 接收缓冲区</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">can_send</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_size</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;检查是否可以发送数据&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">available_window</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">send_window</span><span class="p">[</span><span class="s2">&#34;size&#34;</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">send_window</span><span class="p">[</span><span class="s2">&#34;used&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">data_size</span> <span class="o">&lt;=</span> <span class="n">available_window</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">send_segment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_size</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;发送数据段&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">can_send</span><span class="p">(</span><span class="n">data_size</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;状态&#34;</span><span class="p">:</span> <span class="s2">&#34;窗口已满&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;可用窗口&#34;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">send_window</span><span class="p">[</span><span class="s2">&#34;size&#34;</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">send_window</span><span class="p">[</span><span class="s2">&#34;used&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;请求大小&#34;</span><span class="p">:</span> <span class="n">data_size</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># 发送数据</span>
</span></span><span class="line"><span class="cl">        <span class="n">seq_num</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">send_window</span><span class="p">[</span><span class="s2">&#34;next_seq&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">send_window</span><span class="p">[</span><span class="s2">&#34;next_seq&#34;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">data_size</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">send_window</span><span class="p">[</span><span class="s2">&#34;used&#34;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">data_size</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;状态&#34;</span><span class="p">:</span> <span class="s2">&#34;发送成功&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;序列号&#34;</span><span class="p">:</span> <span class="n">seq_num</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;数据大小&#34;</span><span class="p">:</span> <span class="n">data_size</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;剩余窗口&#34;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">send_window</span><span class="p">[</span><span class="s2">&#34;size&#34;</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">send_window</span><span class="p">[</span><span class="s2">&#34;used&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">receive_ack</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ack_num</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;接收确认&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">ack_num</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">send_window</span><span class="p">[</span><span class="s2">&#34;base&#34;</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># 滑动发送窗口</span>
</span></span><span class="line"><span class="cl">            <span class="n">acked_bytes</span> <span class="o">=</span> <span class="n">ack_num</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">send_window</span><span class="p">[</span><span class="s2">&#34;base&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">send_window</span><span class="p">[</span><span class="s2">&#34;base&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ack_num</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">send_window</span><span class="p">[</span><span class="s2">&#34;used&#34;</span><span class="p">]</span> <span class="o">-=</span> <span class="n">acked_bytes</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;状态&#34;</span><span class="p">:</span> <span class="s2">&#34;窗口滑动&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;确认字节数&#34;</span><span class="p">:</span> <span class="n">acked_bytes</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;新窗口基序号&#34;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">send_window</span><span class="p">[</span><span class="s2">&#34;base&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;可用窗口&#34;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">send_window</span><span class="p">[</span><span class="s2">&#34;size&#34;</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">send_window</span><span class="p">[</span><span class="s2">&#34;used&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="p">{</span><span class="s2">&#34;状态&#34;</span><span class="p">:</span> <span class="s2">&#34;重复确认&#34;</span><span class="p">,</span> <span class="s2">&#34;确认号&#34;</span><span class="p">:</span> <span class="n">ack_num</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">receive_segment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">seq_num</span><span class="p">,</span> <span class="n">data_size</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;接收数据段&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># 检查是否在接收窗口内</span>
</span></span><span class="line"><span class="cl">        <span class="n">window_end</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">receive_window</span><span class="p">[</span><span class="s2">&#34;base&#34;</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">receive_window</span><span class="p">[</span><span class="s2">&#34;size&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">seq_num</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">receive_window</span><span class="p">[</span><span class="s2">&#34;base&#34;</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="p">{</span><span class="s2">&#34;状态&#34;</span><span class="p">:</span> <span class="s2">&#34;重复数据&#34;</span><span class="p">,</span> <span class="s2">&#34;序列号&#34;</span><span class="p">:</span> <span class="n">seq_num</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">seq_num</span> <span class="o">&gt;=</span> <span class="n">window_end</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="p">{</span><span class="s2">&#34;状态&#34;</span><span class="p">:</span> <span class="s2">&#34;超出窗口&#34;</span><span class="p">,</span> <span class="s2">&#34;序列号&#34;</span><span class="p">:</span> <span class="n">seq_num</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># 接收数据</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">receive_window</span><span class="p">[</span><span class="s2">&#34;buffer&#34;</span><span class="p">][</span><span class="n">seq_num</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_size</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># 检查是否可以滑动窗口</span>
</span></span><span class="line"><span class="cl">        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">receive_window</span><span class="p">[</span><span class="s2">&#34;base&#34;</span><span class="p">]</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">receive_window</span><span class="p">[</span><span class="s2">&#34;buffer&#34;</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">            <span class="n">data_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">receive_window</span><span class="p">[</span><span class="s2">&#34;buffer&#34;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">receive_window</span><span class="p">[</span><span class="s2">&#34;base&#34;</span><span class="p">]]</span>
</span></span><span class="line"><span class="cl">            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">receive_window</span><span class="p">[</span><span class="s2">&#34;buffer&#34;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">receive_window</span><span class="p">[</span><span class="s2">&#34;base&#34;</span><span class="p">]]</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">receive_window</span><span class="p">[</span><span class="s2">&#34;base&#34;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">data_size</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># 更新可用窗口</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">receive_window</span><span class="p">[</span><span class="s2">&#34;available&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">receive_window</span><span class="p">[</span><span class="s2">&#34;size&#34;</span><span class="p">]</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">receive_window</span><span class="p">[</span><span class="s2">&#34;buffer&#34;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;状态&#34;</span><span class="p">:</span> <span class="s2">&#34;接收成功&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;确认号&#34;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">receive_window</span><span class="p">[</span><span class="s2">&#34;base&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;窗口大小&#34;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">receive_window</span><span class="p">[</span><span class="s2">&#34;available&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">update_window_size</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_size</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;更新窗口大小&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">old_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">receive_window</span><span class="p">[</span><span class="s2">&#34;size&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">receive_window</span><span class="p">[</span><span class="s2">&#34;size&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_size</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">receive_window</span><span class="p">[</span><span class="s2">&#34;available&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_size</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">receive_window</span><span class="p">[</span><span class="s2">&#34;buffer&#34;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;旧窗口大小&#34;</span><span class="p">:</span> <span class="n">old_size</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;新窗口大小&#34;</span><span class="p">:</span> <span class="n">new_size</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;可用窗口&#34;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">receive_window</span><span class="p">[</span><span class="s2">&#34;available&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 流量控制示例</span>
</span></span><span class="line"><span class="cl"><span class="n">flow_control</span> <span class="o">=</span> <span class="n">TCPFlowControl</span><span class="p">(</span><span class="n">window_size</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="s2">&#34;TCP流量控制示例:&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;初始发送窗口: </span><span class="si">{</span><span class="n">flow_control</span><span class="o">.</span><span class="n">send_window</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;初始接收窗口: </span><span class="si">{</span><span class="n">flow_control</span><span class="o">.</span><span class="n">receive_window</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 发送数据</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">发送数据:&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">size</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">([</span><span class="mi">300</span><span class="p">,</span> <span class="mi">400</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">150</span><span class="p">],</span> <span class="mi">1</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">result</span> <span class="o">=</span> <span class="n">flow_control</span><span class="o">.</span><span class="n">send_segment</span><span class="p">(</span><span class="n">size</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;发送</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">result</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 接收确认</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">接收确认:&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">ack_result</span> <span class="o">=</span> <span class="n">flow_control</span><span class="o">.</span><span class="n">receive_ack</span><span class="p">(</span><span class="mi">1700</span><span class="p">)</span>  <span class="c1"># 确认前700字节</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;确认结果: </span><span class="si">{</span><span class="n">ack_result</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 继续发送</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">继续发送:&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">result</span> <span class="o">=</span> <span class="n">flow_control</span><span class="o">.</span><span class="n">send_segment</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;发送结果: </span><span class="si">{</span><span class="n">result</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span></code></pre></div><h2 id="tcp拥塞控制">TCP拥塞控制<a hidden class="anchor" aria-hidden="true" href="#tcp拥塞控制">#</a></h2>
<h3 id="拥塞控制算法">拥塞控制算法<a hidden class="anchor" aria-hidden="true" href="#拥塞控制算法">#</a></h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">TCPCongestionControl</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;TCP拥塞控制&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">cwnd</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># 拥塞窗口（MSS单位）</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">ssthresh</span> <span class="o">=</span> <span class="mi">64</span>  <span class="c1"># 慢启动阈值</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">mss</span> <span class="o">=</span> <span class="mi">1460</span>  <span class="c1"># 最大段大小</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="s2">&#34;slow_start&#34;</span>  <span class="c1"># 拥塞控制状态</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">dup_ack_count</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># 重复ACK计数</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">rtt_samples</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">rto</span> <span class="o">=</span> <span class="mf">1.0</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">algorithms</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;Reno&#34;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">reno_algorithm</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;Cubic&#34;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">cubic_algorithm</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;BBR&#34;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">bbr_algorithm</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">reno_algorithm</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;TCP Reno算法&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">event</span> <span class="o">==</span> <span class="s2">&#34;ack_received&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="s2">&#34;slow_start&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="c1"># 慢启动：每收到一个ACK，cwnd增加1</span>
</span></span><span class="line"><span class="cl">                <span class="bp">self</span><span class="o">.</span><span class="n">cwnd</span> <span class="o">+=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cwnd</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ssthresh</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="s2">&#34;congestion_avoidance&#34;</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="s2">&#34;congestion_avoidance&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="c1"># 拥塞避免：每个RTT，cwnd增加1</span>
</span></span><span class="line"><span class="cl">                <span class="bp">self</span><span class="o">.</span><span class="n">cwnd</span> <span class="o">+=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">cwnd</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">dup_ack_count</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="k">elif</span> <span class="n">event</span> <span class="o">==</span> <span class="s2">&#34;duplicate_ack&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">dup_ack_count</span> <span class="o">+=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dup_ack_count</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="c1"># 快速重传</span>
</span></span><span class="line"><span class="cl">                <span class="bp">self</span><span class="o">.</span><span class="n">ssthresh</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cwnd</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="bp">self</span><span class="o">.</span><span class="n">cwnd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ssthresh</span> <span class="o">+</span> <span class="mi">3</span>
</span></span><span class="line"><span class="cl">                <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="s2">&#34;fast_recovery&#34;</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="s2">&#34;fast_recovery&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="bp">self</span><span class="o">.</span><span class="n">cwnd</span> <span class="o">+=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="k">elif</span> <span class="n">event</span> <span class="o">==</span> <span class="s2">&#34;timeout&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># 超时重传</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">ssthresh</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cwnd</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">cwnd</span> <span class="o">=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="s2">&#34;slow_start&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">dup_ack_count</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="k">elif</span> <span class="n">event</span> <span class="o">==</span> <span class="s2">&#34;new_ack&#34;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="s2">&#34;fast_recovery&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># 快速恢复结束</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">cwnd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ssthresh</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="s2">&#34;congestion_avoidance&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">dup_ack_count</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">cubic_algorithm</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;TCP CUBIC算法（简化版）&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;cubic_state&#39;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">cubic_state</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="s1">&#39;w_max&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">cwnd</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s1">&#39;k&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s1">&#39;w_est&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s1">&#39;epoch_start&#39;</span><span class="p">:</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">event</span> <span class="o">==</span> <span class="s2">&#34;ack_received&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">current_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="n">t</span> <span class="o">=</span> <span class="n">current_time</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">cubic_state</span><span class="p">[</span><span class="s1">&#39;epoch_start&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="c1"># CUBIC函数：W(t) = C(t-K)³ + W_max</span>
</span></span><span class="line"><span class="cl">            <span class="n">C</span> <span class="o">=</span> <span class="mf">0.4</span>  <span class="c1"># CUBIC参数</span>
</span></span><span class="line"><span class="cl">            <span class="n">K</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cubic_state</span><span class="p">[</span><span class="s1">&#39;k&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">            <span class="n">W_max</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cubic_state</span><span class="p">[</span><span class="s1">&#39;w_max&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="n">w_cubic</span> <span class="o">=</span> <span class="n">C</span> <span class="o">*</span> <span class="p">((</span><span class="n">t</span> <span class="o">-</span> <span class="n">K</span><span class="p">)</span> <span class="o">**</span> <span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="n">W_max</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="c1"># 友好性检查</span>
</span></span><span class="line"><span class="cl">            <span class="n">w_est</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cubic_state</span><span class="p">[</span><span class="s1">&#39;w_est&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">            <span class="n">w_est</span> <span class="o">+=</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="n">w_est</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">cwnd</span><span class="p">)</span>  <span class="c1"># Reno-friendly</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">w_cubic</span> <span class="o">&lt;</span> <span class="n">w_est</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="bp">self</span><span class="o">.</span><span class="n">cwnd</span> <span class="o">=</span> <span class="n">w_est</span>
</span></span><span class="line"><span class="cl">            <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="bp">self</span><span class="o">.</span><span class="n">cwnd</span> <span class="o">=</span> <span class="n">w_cubic</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">cubic_state</span><span class="p">[</span><span class="s1">&#39;w_est&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">w_est</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="k">elif</span> <span class="n">event</span> <span class="o">==</span> <span class="s2">&#34;congestion&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># 拥塞事件</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">cubic_state</span><span class="p">[</span><span class="s1">&#39;w_max&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cwnd</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">cwnd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cwnd</span> <span class="o">*</span> <span class="mf">0.7</span>  <span class="c1"># CUBIC的β值</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">cubic_state</span><span class="p">[</span><span class="s1">&#39;k&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cubic_state</span><span class="p">[</span><span class="s1">&#39;w_max&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">0.3</span> <span class="o">/</span> <span class="mf">0.4</span><span class="p">)</span> <span class="o">**</span> <span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="mi">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">cubic_state</span><span class="p">[</span><span class="s1">&#39;epoch_start&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">bbr_algorithm</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;BBR算法（简化版）&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;bbr_state&#39;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">bbr_state</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="s1">&#39;mode&#39;</span><span class="p">:</span> <span class="s1">&#39;startup&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s1">&#39;pacing_rate&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s1">&#39;bandwidth&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s1">&#39;rtt_min&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                <span class="s1">&#39;cycle_index&#39;</span><span class="p">:</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">event</span> <span class="o">==</span> <span class="s2">&#34;ack_received&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">rtt</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;rtt&#39;</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">delivered</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;delivered&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mss</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="c1"># 更新带宽估计</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">rtt</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">bw_sample</span> <span class="o">=</span> <span class="n">delivered</span> <span class="o">/</span> <span class="n">rtt</span>
</span></span><span class="line"><span class="cl">                <span class="bp">self</span><span class="o">.</span><span class="n">bbr_state</span><span class="p">[</span><span class="s1">&#39;bandwidth&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bbr_state</span><span class="p">[</span><span class="s1">&#39;bandwidth&#39;</span><span class="p">],</span> <span class="n">bw_sample</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="c1"># 更新最小RTT</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">bbr_state</span><span class="p">[</span><span class="s1">&#39;rtt_min&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bbr_state</span><span class="p">[</span><span class="s1">&#39;rtt_min&#39;</span><span class="p">],</span> <span class="n">rtt</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="c1"># 计算BDP（带宽时延积）</span>
</span></span><span class="line"><span class="cl">            <span class="n">bdp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bbr_state</span><span class="p">[</span><span class="s1">&#39;bandwidth&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">bbr_state</span><span class="p">[</span><span class="s1">&#39;rtt_min&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bbr_state</span><span class="p">[</span><span class="s1">&#39;mode&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;startup&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="c1"># 启动阶段：快速探测带宽</span>
</span></span><span class="line"><span class="cl">                <span class="bp">self</span><span class="o">.</span><span class="n">cwnd</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">bdp</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cwnd</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cwnd</span> <span class="o">&gt;</span> <span class="mi">1000</span><span class="p">:</span>  <span class="c1"># 简化的退出条件</span>
</span></span><span class="line"><span class="cl">                    <span class="bp">self</span><span class="o">.</span><span class="n">bbr_state</span><span class="p">[</span><span class="s1">&#39;mode&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;drain&#39;</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">bbr_state</span><span class="p">[</span><span class="s1">&#39;mode&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;drain&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="c1"># 排空阶段</span>
</span></span><span class="line"><span class="cl">                <span class="bp">self</span><span class="o">.</span><span class="n">cwnd</span> <span class="o">=</span> <span class="n">bdp</span>
</span></span><span class="line"><span class="cl">                <span class="bp">self</span><span class="o">.</span><span class="n">bbr_state</span><span class="p">[</span><span class="s1">&#39;mode&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;probe_bw&#39;</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">bbr_state</span><span class="p">[</span><span class="s1">&#39;mode&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;probe_bw&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="c1"># 带宽探测阶段</span>
</span></span><span class="line"><span class="cl">                <span class="n">gain_cycle</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.25</span><span class="p">,</span> <span class="mf">0.75</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">                <span class="n">gain</span> <span class="o">=</span> <span class="n">gain_cycle</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">bbr_state</span><span class="p">[</span><span class="s1">&#39;cycle_index&#39;</span><span class="p">]]</span>
</span></span><span class="line"><span class="cl">                <span class="bp">self</span><span class="o">.</span><span class="n">cwnd</span> <span class="o">=</span> <span class="n">gain</span> <span class="o">*</span> <span class="n">bdp</span>
</span></span><span class="line"><span class="cl">                
</span></span><span class="line"><span class="cl">                <span class="bp">self</span><span class="o">.</span><span class="n">bbr_state</span><span class="p">[</span><span class="s1">&#39;cycle_index&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bbr_state</span><span class="p">[</span><span class="s1">&#39;cycle_index&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">gain_cycle</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">simulate_congestion_control</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">algorithm</span><span class="o">=</span><span class="s2">&#34;Reno&#34;</span><span class="p">,</span> <span class="n">events</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;模拟拥塞控制过程&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">events</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">events</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">                <span class="p">(</span><span class="s2">&#34;ack_received&#34;</span><span class="p">,</span> <span class="p">{}),</span>
</span></span><span class="line"><span class="cl">                <span class="p">(</span><span class="s2">&#34;ack_received&#34;</span><span class="p">,</span> <span class="p">{}),</span>
</span></span><span class="line"><span class="cl">                <span class="p">(</span><span class="s2">&#34;ack_received&#34;</span><span class="p">,</span> <span class="p">{}),</span>
</span></span><span class="line"><span class="cl">                <span class="p">(</span><span class="s2">&#34;duplicate_ack&#34;</span><span class="p">,</span> <span class="p">{}),</span>
</span></span><span class="line"><span class="cl">                <span class="p">(</span><span class="s2">&#34;duplicate_ack&#34;</span><span class="p">,</span> <span class="p">{}),</span>
</span></span><span class="line"><span class="cl">                <span class="p">(</span><span class="s2">&#34;duplicate_ack&#34;</span><span class="p">,</span> <span class="p">{}),</span>  <span class="c1"># 触发快速重传</span>
</span></span><span class="line"><span class="cl">                <span class="p">(</span><span class="s2">&#34;new_ack&#34;</span><span class="p">,</span> <span class="p">{}),</span>
</span></span><span class="line"><span class="cl">                <span class="p">(</span><span class="s2">&#34;timeout&#34;</span><span class="p">,</span> <span class="p">{}),</span>
</span></span><span class="line"><span class="cl">                <span class="p">(</span><span class="s2">&#34;ack_received&#34;</span><span class="p">,</span> <span class="p">{}),</span>
</span></span><span class="line"><span class="cl">                <span class="p">(</span><span class="s2">&#34;ack_received&#34;</span><span class="p">,</span> <span class="p">{})</span>
</span></span><span class="line"><span class="cl">            <span class="p">]</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="n">history</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">event</span><span class="p">,</span> <span class="n">params</span> <span class="ow">in</span> <span class="n">events</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">old_cwnd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cwnd</span>
</span></span><span class="line"><span class="cl">            <span class="n">old_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="c1"># 执行算法</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">algorithm</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">algorithms</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="bp">self</span><span class="o">.</span><span class="n">algorithms</span><span class="p">[</span><span class="n">algorithm</span><span class="p">](</span><span class="n">event</span><span class="p">,</span> <span class="o">**</span><span class="n">params</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="n">history</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;事件&#34;</span><span class="p">:</span> <span class="n">event</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;旧拥塞窗口&#34;</span><span class="p">:</span> <span class="n">old_cwnd</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;新拥塞窗口&#34;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">cwnd</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;旧状态&#34;</span><span class="p">:</span> <span class="n">old_state</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;新状态&#34;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;慢启动阈值&#34;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">ssthresh</span>
</span></span><span class="line"><span class="cl">            <span class="p">})</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">history</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 拥塞控制示例</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">time</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">congestion_control</span> <span class="o">=</span> <span class="n">TCPCongestionControl</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="s2">&#34;TCP拥塞控制示例 (Reno算法):&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">history</span> <span class="o">=</span> <span class="n">congestion_control</span><span class="o">.</span><span class="n">simulate_congestion_control</span><span class="p">(</span><span class="s2">&#34;Reno&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">record</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">history</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;步骤</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">record</span><span class="p">[</span><span class="s1">&#39;事件&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;  拥塞窗口: </span><span class="si">{</span><span class="n">record</span><span class="p">[</span><span class="s1">&#39;旧拥塞窗口&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="n">record</span><span class="p">[</span><span class="s1">&#39;新拥塞窗口&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;  状态: </span><span class="si">{</span><span class="n">record</span><span class="p">[</span><span class="s1">&#39;旧状态&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="n">record</span><span class="p">[</span><span class="s1">&#39;新状态&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;  慢启动阈值: </span><span class="si">{</span><span class="n">record</span><span class="p">[</span><span class="s1">&#39;慢启动阈值&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 比较不同算法</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="s2">&#34;不同拥塞控制算法比较:&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">algorithms</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&#34;Reno&#34;</span><span class="p">,</span> <span class="s2">&#34;Cubic&#34;</span><span class="p">,</span> <span class="s2">&#34;BBR&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">alg</span> <span class="ow">in</span> <span class="n">algorithms</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">cc</span> <span class="o">=</span> <span class="n">TCPCongestionControl</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">alg</span> <span class="o">==</span> <span class="s2">&#34;BBR&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># BBR需要特殊的事件参数</span>
</span></span><span class="line"><span class="cl">        <span class="n">events</span> <span class="o">=</span> <span class="p">[(</span><span class="s2">&#34;ack_received&#34;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&#34;rtt&#34;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">,</span> <span class="s2">&#34;delivered&#34;</span><span class="p">:</span> <span class="mi">1460</span><span class="p">})</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">events</span> <span class="o">=</span> <span class="p">[(</span><span class="s2">&#34;ack_received&#34;</span><span class="p">,</span> <span class="p">{})</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="n">history</span> <span class="o">=</span> <span class="n">cc</span><span class="o">.</span><span class="n">simulate_congestion_control</span><span class="p">(</span><span class="n">alg</span><span class="p">,</span> <span class="n">events</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">final_cwnd</span> <span class="o">=</span> <span class="n">history</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s2">&#34;新拥塞窗口&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;</span><span class="si">{</span><span class="n">alg</span><span class="si">}</span><span class="s2">: 最终拥塞窗口 = </span><span class="si">{</span><span class="n">final_cwnd</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span></code></pre></div><h2 id="tcp性能优化">TCP性能优化<a hidden class="anchor" aria-hidden="true" href="#tcp性能优化">#</a></h2>
<h3 id="性能调优技术">性能调优技术<a hidden class="anchor" aria-hidden="true" href="#性能调优技术">#</a></h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">TCPPerformanceOptimization</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;TCP性能优化&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">optimization_techniques</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;窗口缩放&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;描述&#34;</span><span class="p">:</span> <span class="s2">&#34;支持大于64KB的窗口&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;RFC&#34;</span><span class="p">:</span> <span class="s2">&#34;RFC 7323&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;适用场景&#34;</span><span class="p">:</span> <span class="s2">&#34;高带宽长延迟网络&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="p">},</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;选择性确认&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;描述&#34;</span><span class="p">:</span> <span class="s2">&#34;SACK选项，提高重传效率&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;RFC&#34;</span><span class="p">:</span> <span class="s2">&#34;RFC 2018&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;适用场景&#34;</span><span class="p">:</span> <span class="s2">&#34;丢包率较高的网络&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="p">},</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;时间戳选项&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;描述&#34;</span><span class="p">:</span> <span class="s2">&#34;精确RTT测量和PAWS&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;RFC&#34;</span><span class="p">:</span> <span class="s2">&#34;RFC 7323&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;适用场景&#34;</span><span class="p">:</span> <span class="s2">&#34;需要精确RTT测量&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="p">},</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;Nagle算法&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;描述&#34;</span><span class="p">:</span> <span class="s2">&#34;减少小包发送&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;适用场景&#34;</span><span class="p">:</span> <span class="s2">&#34;批量数据传输&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;注意事项&#34;</span><span class="p">:</span> <span class="s2">&#34;可能增加延迟&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="p">},</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;延迟确认&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;描述&#34;</span><span class="p">:</span> <span class="s2">&#34;合并ACK减少网络流量&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;适用场景&#34;</span><span class="p">:</span> <span class="s2">&#34;双向数据流&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;注意事项&#34;</span><span class="p">:</span> <span class="s2">&#34;可能增加RTT&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">calculate_bandwidth_delay_product</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bandwidth_mbps</span><span class="p">,</span> <span class="n">rtt_ms</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;计算带宽时延积&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">bandwidth_bps</span> <span class="o">=</span> <span class="n">bandwidth_mbps</span> <span class="o">*</span> <span class="mi">1_000_000</span>
</span></span><span class="line"><span class="cl">        <span class="n">rtt_seconds</span> <span class="o">=</span> <span class="n">rtt_ms</span> <span class="o">/</span> <span class="mi">1000</span>
</span></span><span class="line"><span class="cl">        <span class="n">bdp_bytes</span> <span class="o">=</span> <span class="n">bandwidth_bps</span> <span class="o">*</span> <span class="n">rtt_seconds</span> <span class="o">/</span> <span class="mi">8</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;带宽&#34;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&#34;</span><span class="si">{</span><span class="n">bandwidth_mbps</span><span class="si">}</span><span class="s2"> Mbps&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;RTT&#34;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&#34;</span><span class="si">{</span><span class="n">rtt_ms</span><span class="si">}</span><span class="s2"> ms&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;BDP&#34;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&#34;</span><span class="si">{</span><span class="n">bdp_bytes</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2"> bytes&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;建议窗口大小&#34;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&#34;</span><span class="si">{</span><span class="n">bdp_bytes</span> <span class="o">*</span> <span class="mi">2</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2"> bytes&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;需要窗口缩放&#34;</span><span class="p">:</span> <span class="n">bdp_bytes</span> <span class="o">&gt;</span> <span class="mi">65535</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">analyze_tcp_performance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">throughput_mbps</span><span class="p">,</span> <span class="n">rtt_ms</span><span class="p">,</span> <span class="n">loss_rate</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;分析TCP性能&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># Mathis公式：Throughput ≤ (MSS / RTT) * sqrt(1.5 / p)</span>
</span></span><span class="line"><span class="cl">        <span class="n">mss</span> <span class="o">=</span> <span class="mi">1460</span>  <span class="c1"># 字节</span>
</span></span><span class="line"><span class="cl">        <span class="n">rtt_seconds</span> <span class="o">=</span> <span class="n">rtt_ms</span> <span class="o">/</span> <span class="mi">1000</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">loss_rate</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">theoretical_max</span> <span class="o">=</span> <span class="p">(</span><span class="n">mss</span> <span class="o">/</span> <span class="n">rtt_seconds</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.5</span> <span class="o">/</span> <span class="n">loss_rate</span><span class="p">)</span> <span class="o">**</span> <span class="mf">0.5</span> <span class="o">/</span> <span class="mi">1_000_000</span> <span class="o">*</span> <span class="mi">8</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">theoretical_max</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># 窗口限制的吞吐量</span>
</span></span><span class="line"><span class="cl">        <span class="n">window_limited</span> <span class="o">=</span> <span class="p">(</span><span class="mi">65535</span> <span class="o">/</span> <span class="n">rtt_seconds</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1_000_000</span> <span class="o">*</span> <span class="mi">8</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="n">efficiency</span> <span class="o">=</span> <span class="p">(</span><span class="n">throughput_mbps</span> <span class="o">/</span> <span class="nb">min</span><span class="p">(</span><span class="n">theoretical_max</span><span class="p">,</span> <span class="n">window_limited</span><span class="p">))</span> <span class="o">*</span> <span class="mi">100</span> <span class="k">if</span> <span class="n">theoretical_max</span> <span class="o">!=</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="n">analysis</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;实际吞吐量&#34;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&#34;</span><span class="si">{</span><span class="n">throughput_mbps</span><span class="si">}</span><span class="s2"> Mbps&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;理论最大吞吐量&#34;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&#34;</span><span class="si">{</span><span class="n">theoretical_max</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> Mbps&#34;</span> <span class="k">if</span> <span class="n">theoretical_max</span> <span class="o">!=</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="s2">&#34;无限制&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;窗口限制吞吐量&#34;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&#34;</span><span class="si">{</span><span class="n">window_limited</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> Mbps&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;效率&#34;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&#34;</span><span class="si">{</span><span class="n">efficiency</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;性能瓶颈&#34;</span><span class="p">:</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># 识别性能瓶颈</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">throughput_mbps</span> <span class="o">&lt;</span> <span class="n">window_limited</span> <span class="o">*</span> <span class="mf">0.8</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">analysis</span><span class="p">[</span><span class="s2">&#34;性能瓶颈&#34;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&#34;可能受拥塞控制限制&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">window_limited</span> <span class="o">&lt;</span> <span class="n">theoretical_max</span> <span class="o">*</span> <span class="mf">0.8</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">analysis</span><span class="p">[</span><span class="s2">&#34;性能瓶颈&#34;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&#34;受接收窗口限制，建议启用窗口缩放&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">loss_rate</span> <span class="o">&gt;</span> <span class="mf">0.01</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">analysis</span><span class="p">[</span><span class="s2">&#34;性能瓶颈&#34;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&#34;丢包率过高，影响性能&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">analysis</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">recommend_optimizations</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scenario</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;推荐优化方案&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">recommendations</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;高带宽长延迟&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;启用窗口缩放选项&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;使用CUBIC或BBR拥塞控制&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;调整接收缓冲区大小&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;考虑使用多连接并行传输&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="p">],</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;高丢包率&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;启用SACK选项&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;使用更激进的拥塞控制算法&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;考虑使用FEC（前向纠错）&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;优化重传策略&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="p">],</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;低延迟要求&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;禁用Nagle算法&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;减少延迟确认时间&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;使用专用网络路径&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;优化应用层协议&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="p">],</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;移动网络&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;使用BBR拥塞控制&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;启用连接迁移&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;考虑使用MPTCP&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;优化重传超时&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="p">],</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;数据中心&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;使用DCTCP算法&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;启用ECN标记&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;优化缓冲区管理&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;使用RDMA技术&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">recommendations</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">scenario</span><span class="p">,</span> <span class="p">[</span><span class="s2">&#34;请提供具体场景&#34;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 性能优化示例</span>
</span></span><span class="line"><span class="cl"><span class="n">perf_optimizer</span> <span class="o">=</span> <span class="n">TCPPerformanceOptimization</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 计算BDP</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="s2">&#34;带宽时延积计算:&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">scenarios</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span>   <span class="c1"># 100Mbps, 10ms RTT</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="mi">1000</span><span class="p">,</span> <span class="mi">50</span><span class="p">),</span>  <span class="c1"># 1Gbps, 50ms RTT</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">200</span><span class="p">)</span>    <span class="c1"># 10Mbps, 200ms RTT</span>
</span></span><span class="line"><span class="cl"><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">bandwidth</span><span class="p">,</span> <span class="n">rtt</span> <span class="ow">in</span> <span class="n">scenarios</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">bdp</span> <span class="o">=</span> <span class="n">perf_optimizer</span><span class="o">.</span><span class="n">calculate_bandwidth_delay_product</span><span class="p">(</span><span class="n">bandwidth</span><span class="p">,</span> <span class="n">rtt</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">场景: </span><span class="si">{</span><span class="n">bdp</span><span class="p">[</span><span class="s1">&#39;带宽&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">bdp</span><span class="p">[</span><span class="s1">&#39;RTT&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;  BDP: </span><span class="si">{</span><span class="n">bdp</span><span class="p">[</span><span class="s1">&#39;BDP&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;  建议窗口: </span><span class="si">{</span><span class="n">bdp</span><span class="p">[</span><span class="s1">&#39;建议窗口大小&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;  需要窗口缩放: </span><span class="si">{</span><span class="n">bdp</span><span class="p">[</span><span class="s1">&#39;需要窗口缩放&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 性能分析</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\n\n</span><span class="s2">TCP性能分析:&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">performance_cases</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mf">0.001</span><span class="p">),</span>    <span class="c1"># 50Mbps实际，10ms RTT，0.1%丢包</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="mi">800</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">),</span>    <span class="c1"># 800Mbps实际，50ms RTT，1%丢包</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">)</span>      <span class="c1"># 5Mbps实际，200ms RTT，5%丢包</span>
</span></span><span class="line"><span class="cl"><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">throughput</span><span class="p">,</span> <span class="n">rtt</span><span class="p">,</span> <span class="n">loss</span> <span class="ow">in</span> <span class="n">performance_cases</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">analysis</span> <span class="o">=</span> <span class="n">perf_optimizer</span><span class="o">.</span><span class="n">analyze_tcp_performance</span><span class="p">(</span><span class="n">throughput</span><span class="p">,</span> <span class="n">rtt</span><span class="p">,</span> <span class="n">loss</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">场景: </span><span class="si">{</span><span class="n">throughput</span><span class="si">}</span><span class="s2">Mbps, </span><span class="si">{</span><span class="n">rtt</span><span class="si">}</span><span class="s2">ms RTT, </span><span class="si">{</span><span class="n">loss</span><span class="o">*</span><span class="mi">100</span><span class="si">}</span><span class="s2">%丢包&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;  实际吞吐量: </span><span class="si">{</span><span class="n">analysis</span><span class="p">[</span><span class="s1">&#39;实际吞吐量&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;  理论最大: </span><span class="si">{</span><span class="n">analysis</span><span class="p">[</span><span class="s1">&#39;理论最大吞吐量&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;  效率: </span><span class="si">{</span><span class="n">analysis</span><span class="p">[</span><span class="s1">&#39;效率&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">analysis</span><span class="p">[</span><span class="s1">&#39;性能瓶颈&#39;</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;  瓶颈: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">analysis</span><span class="p">[</span><span class="s1">&#39;性能瓶颈&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 优化建议</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\n\n</span><span class="s2">优化建议:&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">scenarios</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&#34;高带宽长延迟&#34;</span><span class="p">,</span> <span class="s2">&#34;高丢包率&#34;</span><span class="p">,</span> <span class="s2">&#34;低延迟要求&#34;</span><span class="p">,</span> <span class="s2">&#34;移动网络&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">scenario</span> <span class="ow">in</span> <span class="n">scenarios</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">recommendations</span> <span class="o">=</span> <span class="n">perf_optimizer</span><span class="o">.</span><span class="n">recommend_optimizations</span><span class="p">(</span><span class="n">scenario</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;</span><span class="se">\n</span><span class="si">{</span><span class="n">scenario</span><span class="si">}</span><span class="s2">场景:&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">rec</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">recommendations</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;  </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">. </span><span class="si">{</span><span class="n">rec</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span></code></pre></div><h2 id="tcp在现代网络中的应用">TCP在现代网络中的应用<a hidden class="anchor" aria-hidden="true" href="#tcp在现代网络中的应用">#</a></h2>
<h3 id="tcp变种和扩展">TCP变种和扩展<a hidden class="anchor" aria-hidden="true" href="#tcp变种和扩展">#</a></h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">ModernTCPVariants</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;现代TCP变种&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">variants</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;TCP Reno&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;年份&#34;</span><span class="p">:</span> <span class="mi">1990</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;特点&#34;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&#34;快速重传&#34;</span><span class="p">,</span> <span class="s2">&#34;快速恢复&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;适用场景&#34;</span><span class="p">:</span> <span class="s2">&#34;传统网络环境&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;优缺点&#34;</span><span class="p">:</span> <span class="s2">&#34;简单可靠，但在高BDP网络中性能不佳&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="p">},</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;TCP NewReno&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;年份&#34;</span><span class="p">:</span> <span class="mi">1999</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;特点&#34;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&#34;改进的快速恢复&#34;</span><span class="p">,</span> <span class="s2">&#34;部分确认处理&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;适用场景&#34;</span><span class="p">:</span> <span class="s2">&#34;多丢包环境&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;优缺点&#34;</span><span class="p">:</span> <span class="s2">&#34;改善了多丢包处理，但仍有限制&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="p">},</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;TCP SACK&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;年份&#34;</span><span class="p">:</span> <span class="mi">1996</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;特点&#34;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&#34;选择性确认&#34;</span><span class="p">,</span> <span class="s2">&#34;精确重传&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;适用场景&#34;</span><span class="p">:</span> <span class="s2">&#34;丢包率较高的网络&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;优缺点&#34;</span><span class="p">:</span> <span class="s2">&#34;提高重传效率，但增加复杂性&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="p">},</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;TCP Vegas&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;年份&#34;</span><span class="p">:</span> <span class="mi">1994</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;特点&#34;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&#34;基于延迟的拥塞控制&#34;</span><span class="p">,</span> <span class="s2">&#34;主动避免拥塞&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;适用场景&#34;</span><span class="p">:</span> <span class="s2">&#34;延迟敏感应用&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;优缺点&#34;</span><span class="p">:</span> <span class="s2">&#34;低延迟，但与其他算法共存困难&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="p">},</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;TCP CUBIC&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;年份&#34;</span><span class="p">:</span> <span class="mi">2008</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;特点&#34;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&#34;三次函数增长&#34;</span><span class="p">,</span> <span class="s2">&#34;RTT无关&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;适用场景&#34;</span><span class="p">:</span> <span class="s2">&#34;高速长距离网络&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;优缺点&#34;</span><span class="p">:</span> <span class="s2">&#34;高带宽利用率，Linux默认算法&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="p">},</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;TCP BBR&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;年份&#34;</span><span class="p">:</span> <span class="mi">2016</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;特点&#34;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&#34;基于带宽和RTT&#34;</span><span class="p">,</span> <span class="s2">&#34;模型驱动&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;适用场景&#34;</span><span class="p">:</span> <span class="s2">&#34;各种网络环境&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;优缺点&#34;</span><span class="p">:</span> <span class="s2">&#34;优秀的性能，但可能过于激进&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="p">},</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;MPTCP&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;年份&#34;</span><span class="p">:</span> <span class="mi">2013</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;特点&#34;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&#34;多路径传输&#34;</span><span class="p">,</span> <span class="s2">&#34;连接聚合&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;适用场景&#34;</span><span class="p">:</span> <span class="s2">&#34;移动设备、数据中心&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;优缺点&#34;</span><span class="p">:</span> <span class="s2">&#34;提高吞吐量和可靠性，但复杂度高&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="p">},</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;QUIC&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;年份&#34;</span><span class="p">:</span> <span class="mi">2021</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;特点&#34;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&#34;基于UDP&#34;</span><span class="p">,</span> <span class="s2">&#34;内置加密&#34;</span><span class="p">,</span> <span class="s2">&#34;0-RTT&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;适用场景&#34;</span><span class="p">:</span> <span class="s2">&#34;Web应用、实时通信&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;优缺点&#34;</span><span class="p">:</span> <span class="s2">&#34;低延迟，但需要新的基础设施&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">compare_algorithms</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;比较不同算法&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">metrics</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">metrics</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&#34;吞吐量&#34;</span><span class="p">,</span> <span class="s2">&#34;延迟&#34;</span><span class="p">,</span> <span class="s2">&#34;公平性&#34;</span><span class="p">,</span> <span class="s2">&#34;复杂度&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="n">comparison</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;TCP Reno&#34;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&#34;吞吐量&#34;</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span> <span class="s2">&#34;延迟&#34;</span><span class="p">:</span> <span class="mi">7</span><span class="p">,</span> <span class="s2">&#34;公平性&#34;</span><span class="p">:</span> <span class="mi">8</span><span class="p">,</span> <span class="s2">&#34;复杂度&#34;</span><span class="p">:</span> <span class="mi">3</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;TCP CUBIC&#34;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&#34;吞吐量&#34;</span><span class="p">:</span> <span class="mi">9</span><span class="p">,</span> <span class="s2">&#34;延迟&#34;</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span> <span class="s2">&#34;公平性&#34;</span><span class="p">:</span> <span class="mi">7</span><span class="p">,</span> <span class="s2">&#34;复杂度&#34;</span><span class="p">:</span> <span class="mi">5</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;TCP BBR&#34;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&#34;吞吐量&#34;</span><span class="p">:</span> <span class="mi">9</span><span class="p">,</span> <span class="s2">&#34;延迟&#34;</span><span class="p">:</span> <span class="mi">8</span><span class="p">,</span> <span class="s2">&#34;公平性&#34;</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span> <span class="s2">&#34;复杂度&#34;</span><span class="p">:</span> <span class="mi">7</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;MPTCP&#34;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&#34;吞吐量&#34;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span> <span class="s2">&#34;延迟&#34;</span><span class="p">:</span> <span class="mi">7</span><span class="p">,</span> <span class="s2">&#34;公平性&#34;</span><span class="p">:</span> <span class="mi">8</span><span class="p">,</span> <span class="s2">&#34;复杂度&#34;</span><span class="p">:</span> <span class="mi">9</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;QUIC&#34;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&#34;吞吐量&#34;</span><span class="p">:</span> <span class="mi">8</span><span class="p">,</span> <span class="s2">&#34;延迟&#34;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span> <span class="s2">&#34;公平性&#34;</span><span class="p">:</span> <span class="mi">7</span><span class="p">,</span> <span class="s2">&#34;复杂度&#34;</span><span class="p">:</span> <span class="mi">8</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">comparison</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">get_deployment_status</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;获取部署状态&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;TCP Reno/NewReno&#34;</span><span class="p">:</span> <span class="s2">&#34;广泛部署，传统系统默认&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;TCP CUBIC&#34;</span><span class="p">:</span> <span class="s2">&#34;Linux默认，广泛使用&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;TCP BBR&#34;</span><span class="p">:</span> <span class="s2">&#34;Google服务大规模部署，逐渐普及&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;MPTCP&#34;</span><span class="p">:</span> <span class="s2">&#34;移动运营商和数据中心试点&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;QUIC&#34;</span><span class="p">:</span> <span class="s2">&#34;HTTP/3标准，主要浏览器支持&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># TCP安全考虑</span>
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">TCPSecurity</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;TCP安全机制&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">security_issues</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;TCP劫持&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;描述&#34;</span><span class="p">:</span> <span class="s2">&#34;攻击者伪造TCP段接管连接&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;防护措施&#34;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&#34;序列号随机化&#34;</span><span class="p">,</span> <span class="s2">&#34;使用TLS&#34;</span><span class="p">,</span> <span class="s2">&#34;网络分段&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">            <span class="p">},</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;SYN洪水攻击&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;描述&#34;</span><span class="p">:</span> <span class="s2">&#34;大量SYN请求耗尽服务器资源&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;防护措施&#34;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&#34;SYN Cookies&#34;</span><span class="p">,</span> <span class="s2">&#34;连接限制&#34;</span><span class="p">,</span> <span class="s2">&#34;防火墙过滤&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">            <span class="p">},</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;RST攻击&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;描述&#34;</span><span class="p">:</span> <span class="s2">&#34;伪造RST段强制关闭连接&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;防护措施&#34;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&#34;序列号验证&#34;</span><span class="p">,</span> <span class="s2">&#34;使用TLS&#34;</span><span class="p">,</span> <span class="s2">&#34;网络监控&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">            <span class="p">},</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;窗口攻击&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;描述&#34;</span><span class="p">:</span> <span class="s2">&#34;操纵接收窗口影响性能&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;防护措施&#34;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&#34;窗口大小限制&#34;</span><span class="p">,</span> <span class="s2">&#34;流量监控&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">implement_syn_cookies</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client_ip</span><span class="p">,</span> <span class="n">client_port</span><span class="p">,</span> <span class="n">server_port</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;实现SYN Cookies（简化版）&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="kn">import</span> <span class="nn">hashlib</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># 简化的SYN Cookie生成</span>
</span></span><span class="line"><span class="cl">        <span class="n">secret_key</span> <span class="o">=</span> <span class="s2">&#34;tcp_secret_key_2024&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">timestamp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span> <span class="o">//</span> <span class="mi">64</span>  <span class="c1"># 64秒时间窗口</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># 构造Cookie</span>
</span></span><span class="line"><span class="cl">        <span class="n">cookie_data</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&#34;</span><span class="si">{</span><span class="n">client_ip</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">client_port</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">server_port</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">timestamp</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">secret_key</span><span class="si">}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">cookie_hash</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">md5</span><span class="p">(</span><span class="n">cookie_data</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># 取前24位作为序列号</span>
</span></span><span class="line"><span class="cl">        <span class="n">syn_cookie</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">cookie_hash</span><span class="p">[:</span><span class="mi">6</span><span class="p">],</span> <span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;SYN_Cookie&#34;</span><span class="p">:</span> <span class="n">syn_cookie</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;时间戳&#34;</span><span class="p">:</span> <span class="n">timestamp</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;有效期&#34;</span><span class="p">:</span> <span class="s2">&#34;64秒&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;验证方法&#34;</span><span class="p">:</span> <span class="s2">&#34;重新计算并比较&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">validate_syn_cookie</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client_ip</span><span class="p">,</span> <span class="n">client_port</span><span class="p">,</span> <span class="n">server_port</span><span class="p">,</span> <span class="n">received_ack</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;验证SYN Cookie&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="kn">import</span> <span class="nn">hashlib</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="n">secret_key</span> <span class="o">=</span> <span class="s2">&#34;tcp_secret_key_2024&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">current_time</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span> <span class="o">//</span> <span class="mi">64</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># 检查当前和前一个时间窗口</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">timestamp</span> <span class="ow">in</span> <span class="p">[</span><span class="n">current_time</span><span class="p">,</span> <span class="n">current_time</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">            <span class="n">cookie_data</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&#34;</span><span class="si">{</span><span class="n">client_ip</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">client_port</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">server_port</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">timestamp</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">secret_key</span><span class="si">}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="n">cookie_hash</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">md5</span><span class="p">(</span><span class="n">cookie_data</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="n">expected_cookie</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">cookie_hash</span><span class="p">[:</span><span class="mi">6</span><span class="p">],</span> <span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">received_ack</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">==</span> <span class="n">expected_cookie</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="s2">&#34;验证结果&#34;</span><span class="p">:</span> <span class="s2">&#34;成功&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="s2">&#34;时间戳&#34;</span><span class="p">:</span> <span class="n">timestamp</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="s2">&#34;Cookie&#34;</span><span class="p">:</span> <span class="n">expected_cookie</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="p">{</span><span class="s2">&#34;验证结果&#34;</span><span class="p">:</span> <span class="s2">&#34;失败&#34;</span><span class="p">,</span> <span class="s2">&#34;原因&#34;</span><span class="p">:</span> <span class="s2">&#34;Cookie无效或过期&#34;</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 示例使用</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="s2">&#34;现代TCP变种比较:&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">variants</span> <span class="o">=</span> <span class="n">ModernTCPVariants</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">comparison</span> <span class="o">=</span> <span class="n">variants</span><span class="o">.</span><span class="n">compare_algorithms</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">算法性能对比 (1-10分):&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;</span><span class="si">{</span><span class="s1">&#39;算法&#39;</span><span class="si">:</span><span class="s2">&lt;12</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="s1">&#39;吞吐量&#39;</span><span class="si">:</span><span class="s2">&lt;8</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="s1">&#39;延迟&#39;</span><span class="si">:</span><span class="s2">&lt;8</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="s1">&#39;公平性&#39;</span><span class="si">:</span><span class="s2">&lt;8</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="s1">&#39;复杂度&#39;</span><span class="si">:</span><span class="s2">&lt;8</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="s2">&#34;-&#34;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">alg</span><span class="p">,</span> <span class="n">scores</span> <span class="ow">in</span> <span class="n">comparison</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;</span><span class="si">{</span><span class="n">alg</span><span class="si">:</span><span class="s2">&lt;12</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">scores</span><span class="p">[</span><span class="s1">&#39;吞吐量&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">&lt;8</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">scores</span><span class="p">[</span><span class="s1">&#39;延迟&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">&lt;8</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">scores</span><span class="p">[</span><span class="s1">&#39;公平性&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">&lt;8</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">scores</span><span class="p">[</span><span class="s1">&#39;复杂度&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">&lt;8</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">部署状态:&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">deployment</span> <span class="o">=</span> <span class="n">variants</span><span class="o">.</span><span class="n">get_deployment_status</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">alg</span><span class="p">,</span> <span class="n">status</span> <span class="ow">in</span> <span class="n">deployment</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;  </span><span class="si">{</span><span class="n">alg</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">status</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># TCP安全示例</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\n\n</span><span class="s2">TCP安全机制:&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">security</span> <span class="o">=</span> <span class="n">TCPSecurity</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># SYN Cookies示例</span>
</span></span><span class="line"><span class="cl"><span class="n">cookie_result</span> <span class="o">=</span> <span class="n">security</span><span class="o">.</span><span class="n">implement_syn_cookies</span><span class="p">(</span><span class="s2">&#34;192.168.1.100&#34;</span><span class="p">,</span> <span class="mi">12345</span><span class="p">,</span> <span class="mi">80</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;SYN Cookie生成: </span><span class="si">{</span><span class="n">cookie_result</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">validation_result</span> <span class="o">=</span> <span class="n">security</span><span class="o">.</span><span class="n">validate_syn_cookie</span><span class="p">(</span><span class="s2">&#34;192.168.1.100&#34;</span><span class="p">,</span> <span class="mi">12345</span><span class="p">,</span> <span class="mi">80</span><span class="p">,</span> <span class="n">cookie_result</span><span class="p">[</span><span class="s2">&#34;SYN_Cookie&#34;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Cookie验证: </span><span class="si">{</span><span class="n">validation_result</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span></code></pre></div><h2 id="学习建议和总结">学习建议和总结<a hidden class="anchor" aria-hidden="true" href="#学习建议和总结">#</a></h2>
<h3 id="tcp学习路径">TCP学习路径<a hidden class="anchor" aria-hidden="true" href="#tcp学习路径">#</a></h3>
<ol>
<li><strong>基础概念</strong>：理解TCP的基本特性和工作原理</li>
<li><strong>协议细节</strong>：掌握报文格式、状态机、连接管理</li>
<li><strong>可靠传输</strong>：学习序列号、确认、重传机制</li>
<li><strong>流量控制</strong>：理解滑动窗口机制</li>
<li><strong>拥塞控制</strong>：掌握各种拥塞控制算法</li>
<li><strong>性能优化</strong>：学习TCP调优技术</li>
<li><strong>现代发展</strong>：了解新的TCP变种和替代方案</li>
</ol>
<h3 id="关键要点总结">关键要点总结<a hidden class="anchor" aria-hidden="true" href="#关键要点总结">#</a></h3>
<table>
  <thead>
      <tr>
          <th>机制</th>
          <th>目的</th>
          <th>实现方式</th>
          <th>重要性</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td><strong>三次握手</strong></td>
          <td>建立可靠连接</td>
          <td>SYN → SYN+ACK → ACK</td>
          <td>基础</td>
      </tr>
      <tr>
          <td><strong>序列号</strong></td>
          <td>保证数据顺序</td>
          <td>32位序列号空间</td>
          <td>核心</td>
      </tr>
      <tr>
          <td><strong>确认机制</strong></td>
          <td>确保数据到达</td>
          <td>累积确认 + 选择确认</td>
          <td>核心</td>
      </tr>
      <tr>
          <td><strong>流量控制</strong></td>
          <td>防止接收方溢出</td>
          <td>滑动窗口</td>
          <td>重要</td>
      </tr>
      <tr>
          <td><strong>拥塞控制</strong></td>
          <td>避免网络拥塞</td>
          <td>慢启动 + 拥塞避免</td>
          <td>关键</td>
      </tr>
  </tbody>
</table>
<h3 id="实际应用建议">实际应用建议<a hidden class="anchor" aria-hidden="true" href="#实际应用建议">#</a></h3>
<ul>
<li><strong>服务器配置</strong>：合理设置TCP参数，如窗口大小、超时时间</li>
<li><strong>应用设计</strong>：考虑TCP的特性，合理使用连接</li>
<li><strong>网络监控</strong>：监控TCP连接状态和性能指标</li>
<li><strong>安全防护</strong>：实施适当的安全措施防范TCP攻击</li>
<li><strong>性能调优</strong>：根据网络环境选择合适的拥塞控制算法</li>
</ul>
<h3 id="未来发展趋势">未来发展趋势<a hidden class="anchor" aria-hidden="true" href="#未来发展趋势">#</a></h3>
<ul>
<li><strong>QUIC协议</strong>：基于UDP的可靠传输，HTTP/3的基础</li>
<li><strong>多路径TCP</strong>：利用多个网络路径提高性能</li>
<li><strong>机器学习</strong>：智能拥塞控制和参数调优</li>
<li><strong>硬件加速</strong>：网卡和交换机的TCP处理加速</li>
<li><strong>云原生优化</strong>：针对容器和微服务的TCP优化</li>
</ul>
<p>TCP协议作为互联网的基石，其深入理解对于网络编程、系统设计和性能优化都至关重要。随着网络技术的发展，TCP也在不断演进，学习其原理和最新发展趋势将有助于构建更高效、更可靠的网络应用。</p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="http://localhost:1313/tags/tcp/">TCP</a></li>
      <li><a href="http://localhost:1313/tags/%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE/">网络协议</a></li>
      <li><a href="http://localhost:1313/tags/%E4%BC%A0%E8%BE%93%E5%B1%82/">传输层</a></li>
      <li><a href="http://localhost:1313/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/">计算机网络</a></li>
      <li><a href="http://localhost:1313/tags/%E5%8F%AF%E9%9D%A0%E4%BC%A0%E8%BE%93/">可靠传输</a></li>
    </ul>
<nav class="paginav">
  <a class="prev" href="http://localhost:1313/posts/java-interfaces-guide/">
    <span class="title">« Prev</span>
    <br>
    <span>Java接口详解：从基础概念到高级应用</span>
  </a>
  <a class="next" href="http://localhost:1313/posts/http-protocol-guide/">
    <span class="title">Next »</span>
    <br>
    <span>HTTP协议详解：从基础到高级应用</span>
  </a>
</nav>

  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2025 <a href="http://localhost:1313/">tyhzxh的个人博客</a></span> · 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
